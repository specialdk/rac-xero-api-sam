<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC XERO API - Integrated Finance Dashboard</title>
    <style>
      /* ====== SAM VERSION ====== */
      /* Organized and consolidated styles with redundancy removed */
      /* ====== GLOBAL RESET & BASE STYLES ====== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* ====== CONNECTION MANAGER STYLES ====== */
      .connection-manager {
        min-height: 100vh;
        padding: 2rem;
        display: block;
      }

      .login-container {
        max-width: 800px;
        margin: 40px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .login-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .login-header h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .login-content {
        padding: 2rem;
      }

      /* ====== STEP INDICATOR ====== */
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        font-size: 0.9rem;
        margin: 0 0.5rem;
      }

      .step.active {
        background: #667eea;
        color: white;
      }

      .step.completed {
        background: #28a745;
        color: white;
      }

      .step-number {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
      }

      /* ====== COMPANY SELECTION STYLES ====== */
      .company-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .company-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
        cursor: pointer;
      }

      .company-item:hover {
        background-color: #f8f9fa;
      }

      .company-item.all-companies {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .company-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 1rem;
        cursor: pointer;
      }

      .company-name {
        flex: 1;
        font-size: 1rem;
      }

      .selection-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        text-align: center;
      }

      /* ====== BUTTONS ====== */
      .continue-btn,
      .oauth-btn,
      .launch-btn {
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
      }

      .continue-btn {
        background: #667eea;
        color: white;
        padding: 1rem 2rem;
        width: 100%;
      }

      .continue-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .oauth-btn {
        background: #28a745;
        color: white;
        padding: 1rem 2rem;
        margin: 0.5rem;
      }

      .oauth-btn.primary {
        background: #667eea;
      }

      .launch-btn {
        background: #667eea;
        color: white;
        padding: 1.5rem 3rem;
        border-radius: 8px;
        font-size: 1.1rem;
        margin-top: 1rem;
      }

      .back-to-connections {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }

      /* ====== OAUTH FLOW STYLES ====== */
      .oauth-flow,
      .completion {
        display: none;
        text-align: center;
      }

      .current-connection {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .progress-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 8px;
        margin: 15px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
      }

      /* ====== SUCCESS/ERROR BOXES ====== */
      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #155724;
      }

      .error-box {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
      }

      /* ====== MAIN DASHBOARD LAYOUT ====== */
      .main-dashboard {
        display: flex; /* CHANGE from 'none' - handle visibility with JS instead */
        flex-direction: column; /* ADD THIS */
        height: 100vh;
        background: #f5f5f5;
      }

      .main-dashboard.hidden {
        display: none;
      }
      .header {
        background: #2c3e50;
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        position: relative;
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      .header .session-info {
        font-size: 14px;
        opacity: 0.9;
      }

      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      /* ====== DASHBOARD PANEL ====== */
      .dashboard-panel {
        flex: 1; /* CHANGE from height: 100% */
        display: flex;
        flex-direction: column;
        background: #fafafa;
        min-height: 0; /* ADD THIS */
      }

      .panel-header {
        background: #34495e;
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 14px;
        border-bottom: 1px solid #2c3e50;
      }

      .dashboard-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        min-height: 0;
      }

      /* ====== COMPANY FILTERS ====== */
      .company-filter-bar {
        background: #ecf0f1;
        padding: 12px 20px;
        border-bottom: 1px solid #bdc3c7;
        font-size: 13px;
      }

      .company-filter-bar .filter-label {
        display: inline-block;
        margin-right: 15px;
        font-weight: 600;
        color: #2c3e50;
      }

      .company-checkboxes {
        display: inline-flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .company-checkbox-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .company-checkbox-item:hover {
        background: rgba(52, 152, 219, 0.1);
      }

      .company-checkbox-item input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
      }

      .company-checkbox-item label {
        font-weight: 500;
        color: #2c3e50;
        cursor: pointer;
        font-size: 12px;
      }

      .company-checkbox-item.balanced label {
        color: #27ae60;
      }

      .company-checkbox-item.imbalanced label {
        color: #e74c3c;
      }

      /* ====== DASHBOARD GRID & CARDS ====== */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .dashboard-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        min-width: 250px;
        min-height: 220px; /* ADD THIS LINE */
        display: flex;
        flex-direction: column;
      }

      .dashboard-card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .dashboard-card h4 {
        color: #34495e;
        margin-bottom: 10px;
        font-size: 14px;
      }

      /* ====== METRICS ====== */
      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-value {
        font-weight: 600;
        color: #27ae60;
      }

      .metric-value.negative {
        color: #e74c3c;
      }

      /* ====== STATUS INDICATORS ====== */
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.balanced {
        background: #27ae60;
      }

      .status-indicator.imbalanced {
        background: #e74c3c;
      }

      /* ====== TOOLBAR ====== */
      .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .toolbar button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .toolbar button:hover {
        background: #f0f0f0;
      }

      .toolbar button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      /* ====== LOADING STATES ====== */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ====== UTILITY CLASSES ====== */
      .hidden {
        display: none !important;
      }

      /* ====== RESPONSIVE DESIGN ====== */
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .company-checkboxes {
          flex-direction: column;
          gap: 6px;
        }

        .main-container {
          flex-direction: column;
        }

        .login-container {
          margin: 20px;
          max-width: none;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }

        .dashboard-content {
          padding: 10px;
        }

        .header {
          padding: 8px 15px;
        }

        .header h1 {
          font-size: 16px;
        }
      }
    </style>
  </head>
  <!-- ====== SECTION 2: HTML STRUCTURE ====== -->
  <!-- Organized and streamlined HTML with redundancy removed -->

  <body>
    <!-- CONNECTION MANAGER SECTION -->
    <div class="connection-manager" id="connectionManager">
      <div class="login-container">
        <div class="login-header">
          <h1>RAC Multi-Company Login Manager</h1>
          <p>Streamlined access to your Xero organisations</p>
        </div>

        <div class="login-content">
          <!-- Step Indicator -->
          <div class="step-indicator">
            <div class="step active" id="step1Indicator">
              <div class="step-number">1</div>
              <span>Select Companies</span>
            </div>
            <div class="step" id="step2Indicator">
              <div class="step-number">2</div>
              <span>OAuth Authentication</span>
            </div>
            <div class="step" id="step3Indicator">
              <div class="step-number">3</div>
              <span>Launch Dashboard</span>
            </div>
          </div>

          <!-- Step 1: Company Selection -->
          <div class="company-selection" id="step1">
            <h2 style="text-align: center; margin-bottom: 1rem; color: #333">
              Select Companies to Connect
            </h2>

            <div class="company-list">
              <!-- ALL Companies Option -->
              <div
                class="company-item all-companies"
                onclick="toggleAllCompanies(event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="all-companies"
                />
                <div class="company-name">🚀 ALL COMPANIES (Quick Connect)</div>
              </div>

              <!-- Individual Companies -->
              <div class="company-item" onclick="toggleCompany('rac', event)">
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-rac"
                />
                <div class="company-name">
                  Rirratjingu Aboriginal Corporation 8538
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('mining', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-mining"
                />
                <div class="company-name">Rirratjingu Mining Pty Ltd 7168</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('property', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-property"
                />
                <div class="company-name">
                  Rirratjingu Property Management & Maintenance Services Pty Ltd
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('enterprises', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-enterprises"
                />
                <div class="company-name">Rirratjingu Enterprises Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('invest', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-invest"
                />
                <div class="company-name">
                  Rirratjingu Invest P/ L ATF Miliditjpi Trust
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('ngarrkuwuy', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-ngarrkuwuy"
                />
                <div class="company-name">Ngarrkuwuy Developments Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('marrin', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-marrin"
                />
                <div class="company-name">
                  Marrin Square Developments Pty Ltd
                </div>
              </div>
            </div>

            <div class="selection-summary" id="selectionSummary">
              <strong>Selected: 0 companies</strong>
            </div>

            <button
              class="continue-btn"
              id="continueBtn"
              onclick="startOAuthFlow()"
              disabled
            >
              Continue with Selected Companies
            </button>
          </div>

          <!-- Step 2: OAuth Flow -->
          <div class="oauth-flow" id="step2">
            <h2>Connecting to Your Companies</h2>

            <div class="current-connection">
              <h3 id="currentCompanyName">Ready to connect...</h3>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="progressFill"
                  style="width: 0%"
                ></div>
              </div>
              <div id="progressText">Preparing connections...</div>
            </div>

            <div class="success-box" id="oauthInstructions">
              <strong>Ready to start:</strong> Click "Start OAuth Flow" to begin
              connecting to your selected companies.
            </div>

            <div id="oauthButtons">
              <button
                class="oauth-btn primary"
                onclick="startNextOAuth()"
                id="startOAuthBtn"
              >
                🔗 Start OAuth Flow
              </button>
            </div>

            <div id="waitingMessage" style="display: none">
              <div class="success-box">
                <strong>Waiting for OAuth completion...</strong><br />
                Complete the Xero authorization, then return here.
              </div>
              <button class="oauth-btn" onclick="checkOAuthStatus()">
                ✅ I've completed the OAuth - Continue
              </button>
            </div>
          </div>

          <!-- Step 3: Completion -->
          <div class="completion" id="step3">
            <h2>🎉 All Companies Connected!</h2>
            <div class="connected-companies" id="connectedCompaniesList"></div>
            <div class="success-box">
              <strong>Ready to launch!</strong> All selected companies are now
              connected.
            </div>
            <button class="launch-btn" onclick="showMainDashboard()">
              🚀 Launch Financial Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN DASHBOARD SECTION -->
    <div class="main-dashboard" id="mainDashboard">
      <div class="header">
        <h1>RAC Financial Dashboard</h1>
        <div class="session-info">
          Session: Active | Connected Companies:
          <span id="connectedCount">0</span>
          <button class="back-to-connections" onclick="backToConnections()">
            🔙 Manage Connections
          </button>
          <button
            class="back-to-connections"
            onclick="refreshConnectionStatus()"
            style="background: #f39c12; margin-left: 5px"
          >
            🔄 Check Connections
          </button>
        </div>
      </div>

      <div class="main-container">
        <div class="dashboard-panel">
          <div class="panel-header">
            <span class="status-indicator balanced" id="dashboardStatus"></span>
            Financial Dashboard - Live Data

            <!-- Company filter in header -->
            <div
              style="
                display: inline-flex;
                gap: 15px;
                margin-left: 30px;
                font-size: 13px;
              "
            >
              <span style="font-weight: 600">Companies:</span>
              <div id="companyFilters" style="display: inline-flex; gap: 10px">
                <!-- Company checkboxes populated by JavaScript -->
              </div>
            </div>

            <!-- ADD THIS: Scroll Mode Toggle -->
            <button
              id="scrollModeToggle"
              onclick="toggleScrollMode()"
              style="
                float: right;
                padding: 4px 10px;
                font-size: 11px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
              "
              title="Toggle full-page scrolling"
            >
              📜 Enable Full Scroll
            </button>
          </div>

          <div class="toolbar">
            <button class="active" onclick="setView('overview', this)">
              Overview
            </button>
            <button onclick="setView('trial-balance', this)">
              Trial Balance
            </button>
            <button onclick="setView('cash-flow', this)">Cash Flow</button>
            <button onclick="setView('p-and-l', this)">P&L</button>
            <button onclick="setView('year-over-year', this)">
              YoY Analysis
            </button>
            <button onclick="setView('alerts', this)">Alerts</button>
          </div>

          <div class="dashboard-content">
            <div id="dashboardData">
              <div class="loading">
                <div class="loading-spinner"></div>
                Loading financial data from connected companies...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    /* ====== SECTION 3: CORE JAVASCRIPT FUNCTIONS ====== */ /* Organized and
    consolidated JavaScript with redundancy removed */

    <script>
      // ====== GLOBAL VARIABLES ======
      const companies = {
        rac: "Rirratjingu Aboriginal Corporation 8538",
        mining: "Rirratjingu Mining Pty Ltd 7168",
        property:
          "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        enterprises: "Rirratjingu Enterprises Pty Ltd",
        invest: "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
        ngarrkuwuy: "Ngarrkuwuy Developments Pty Ltd",
        marrin: "Marrin Square Developments Pty Ltd",
      };

      let selectedCompanies = [];
      let oauthProgress = 0;
      let connectedCompanies = [];
      let isOAuthInProgress = false;
      let activeCompanyFilters = [];
      let currentView = "overview";
      let selectedPeriod = null;

      // ====== PERIOD SELECTION HELPERS ======

      // Get the current fiscal quarter (Jul-Sep=Q1, Oct-Dec=Q2, Jan-Mar=Q3, Apr-Jun=Q4)
      function getCurrentFiscalQuarter() {
        const today = new Date();
        const month = today.getMonth(); // 0-11

        if (month >= 6 && month <= 8) return "Q1"; // Jul-Sep
        if (month >= 9 && month <= 11) return "Q2"; // Oct-Dec
        if (month >= 0 && month <= 2) return "Q3"; // Jan-Mar
        return "Q4"; // Apr-Jun
      }

      // Check if a quarter has actual data (at least 2 days into the quarter)
      function quarterHasData(quarter) {
        const today = new Date();
        const quarterDates = getQuarterDates(quarter);
        const quarterStart = new Date(quarterDates.start);

        // Add 2 days to quarter start
        const minDataDate = new Date(quarterStart);
        minDataDate.setDate(minDataDate.getDate() + 2);

        return today >= minDataDate;
      }

      // Get date ranges and metadata for each period type
      function getPeriodDates(periodType) {
        const today = new Date();
        const fiscalYearStart = new Date(today.getFullYear(), 6, 1); // July 1 of current year

        // Adjust if we're in Jan-Jun, fiscal year started last calendar year
        if (today.getMonth() < 6) {
          fiscalYearStart.setFullYear(fiscalYearStart.getFullYear() - 1);
        }

        switch (periodType) {
          case "Q1":
            return {
              start: "2025-07-01",
              end: "2025-10-01",
              periodEnd: "2025-09-30",
              label: "Q1 FY26 (Jul-Sep 2025)",
              months: 3,
              daysInPeriod: 92, // Jul 31 + Aug 31 + Sep 30
              quarter: "Q1",
            };

          case "Q2":
            return {
              start: "2025-10-01",
              end: "2026-01-01",
              periodEnd: "2025-12-31",
              label: "Q2 FY26 (Oct-Dec 2025)",
              months: 3,
              daysInPeriod: 92, // Oct 31 + Nov 30 + Dec 31
              quarter: "Q2",
            };

          case "Q3":
            return {
              start: "2026-01-01",
              end: "2026-04-01",
              periodEnd: "2026-03-31",
              label: "Q3 FY26 (Jan-Mar 2026)",
              months: 3,
              daysInPeriod: 90, // Jan 31 + Feb 28 + Mar 31 (non-leap year)
              quarter: "Q3",
            };

          case "Q4":
            return {
              start: "2026-04-01",
              end: "2026-07-01",
              periodEnd: "2026-06-30",
              label: "Q4 FY26 (Apr-Jun 2026)",
              months: 3,
              daysInPeriod: 91, // Apr 30 + May 31 + Jun 30
              quarter: "Q4",
            };

          case "CM": // Current Month
            const cmStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const cmEnd = new Date(
              today.getFullYear(),
              today.getMonth() + 1,
              1
            );
            const cmPeriodEnd = new Date(cmEnd.getTime() - 86400000); // Last day of month

            return {
              start: cmStart.toISOString().split("T")[0],
              end: cmEnd.toISOString().split("T")[0],
              periodEnd: cmPeriodEnd.toISOString().split("T")[0],
              label: `Current Month (${cmStart.toLocaleDateString("en-US", {
                month: "short",
                year: "numeric",
              })})`,
              months: 1,
              daysInPeriod: cmPeriodEnd.getDate(),
              quarter: getCurrentQuarterForDate(cmStart),
            };

          case "LM": // Last Month
            const lmStart = new Date(
              today.getFullYear(),
              today.getMonth() - 1,
              1
            );
            const lmEnd = new Date(today.getFullYear(), today.getMonth(), 1);
            const lmPeriodEnd = new Date(lmEnd.getTime() - 86400000);

            return {
              start: lmStart.toISOString().split("T")[0],
              end: lmEnd.toISOString().split("T")[0],
              periodEnd: lmPeriodEnd.toISOString().split("T")[0],
              label: `Last Month (${lmStart.toLocaleDateString("en-US", {
                month: "short",
                year: "numeric",
              })})`,
              months: 1,
              daysInPeriod: lmPeriodEnd.getDate(),
              quarter: getCurrentQuarterForDate(lmStart),
            };

          default:
            return getPeriodDates("Q1"); // Default to Q1
        }
      }

      // Helper to determine which quarter a date falls in
      function getCurrentQuarterForDate(date) {
        const month = date.getMonth();
        if (month >= 6 && month <= 8) return "Q1";
        if (month >= 9 && month <= 11) return "Q2";
        if (month >= 0 && month <= 2) return "Q3";
        return "Q4";
      }

      // Get quarter dates (simplified version for compatibility)
      function getQuarterDates(quarter) {
        return getPeriodDates(quarter);
      }

      // Calculate pro-rated budget for partial periods
      function calculateProRatedBudget(
        quarterBudget,
        quarterDaysTotal,
        daysElapsed
      ) {
        const dailyBudget = quarterBudget / quarterDaysTotal;
        return dailyBudget * daysElapsed;
      }

      // Get days elapsed in current period (for partial period budget calculations)
      // Get days elapsed in current period (for partial period budget calculations)
      function getDaysElapsedInPeriod(periodStart, periodEnd) {
        const today = new Date();
        const start = new Date(periodStart);
        const end = new Date(periodEnd);

        // Normalize to midnight for accurate day counting
        const todayMidnight = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate()
        );
        const startMidnight = new Date(
          start.getFullYear(),
          start.getMonth(),
          start.getDate()
        );
        const endMidnight = new Date(
          end.getFullYear(),
          end.getMonth(),
          end.getDate()
        );

        // If we're before the period, return 0
        if (todayMidnight < startMidnight) return 0;

        // If we're after the period, return full period length
        if (todayMidnight > endMidnight) {
          const diffTime = endMidnight - startMidnight;
          return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        // Otherwise return days from start to today
        const diffTime = todayMidnight - startMidnight;
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
      }

      // ====== CONNECTION MANAGER FUNCTIONS ======

      function loadSavedPreferences() {
        const saved = localStorage.getItem("racCompanyPreferences");
        if (saved) {
          try {
            selectedCompanies = JSON.parse(saved);
            selectedCompanies.forEach((companyId) => {
              const checkbox = document.getElementById(`company-${companyId}`);
              if (checkbox) checkbox.checked = true;
            });
            updateSelectionSummary();
          } catch (error) {
            console.log("No valid saved preferences");
          }
        }
      }

      function savePreferences() {
        localStorage.setItem(
          "racCompanyPreferences",
          JSON.stringify(selectedCompanies)
        );
      }

      function toggleCompany(companyId, event) {
        event.stopPropagation();
        const checkbox = document.getElementById(`company-${companyId}`);
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          if (!selectedCompanies.includes(companyId)) {
            selectedCompanies.push(companyId);
          }
        } else {
          selectedCompanies = selectedCompanies.filter(
            (id) => id !== companyId
          );
          document.getElementById("all-companies").checked = false;
        }

        updateSelectionSummary();
        savePreferences();
      }

      function toggleAllCompanies(event) {
        event.stopPropagation();
        const allCheckbox = document.getElementById("all-companies");
        allCheckbox.checked = !allCheckbox.checked;

        if (allCheckbox.checked) {
          selectedCompanies = Object.keys(companies);
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = true;
          });
        } else {
          selectedCompanies = [];
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = false;
          });
        }

        updateSelectionSummary();
        savePreferences();
      }

      function updateSelectionSummary() {
        const summary = document.getElementById("selectionSummary");
        const continueBtn = document.getElementById("continueBtn");

        summary.innerHTML = `<strong>Selected: ${selectedCompanies.length} companies</strong>`;

        if (selectedCompanies.length > 0) {
          const companyNames = selectedCompanies.map((id) => companies[id]);
          summary.innerHTML += `<br><small>${companyNames.join(", ")}</small>`;
          continueBtn.disabled = false;
        } else {
          continueBtn.disabled = true;
        }
      }

      // ====== OAUTH FLOW FUNCTIONS ======

      function startOAuthFlow() {
        if (selectedCompanies.length === 0) {
          alert("Please select at least one company to continue.");
          return;
        }

        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
        document.getElementById("step1Indicator").classList.add("completed");
        document.getElementById("step1Indicator").classList.remove("active");
        document.getElementById("step2Indicator").classList.add("active");

        oauthProgress = 0;
        connectedCompanies = [];
        localStorage.setItem(
          "oauthCompanies",
          JSON.stringify(selectedCompanies)
        );
        localStorage.setItem("oauthProgress", "0");
        updateOAuthProgress();
      }

      function updateOAuthProgress() {
        const currentCompanyName =
          document.getElementById("currentCompanyName");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        if (oauthProgress < selectedCompanies.length) {
          const companyId = selectedCompanies[oauthProgress];
          const companyName = companies[companyId];

          currentCompanyName.textContent = `Ready to connect: ${companyName} (${
            oauthProgress + 1
          }/${selectedCompanies.length})`;
          const progressPercent =
            (oauthProgress / selectedCompanies.length) * 100;
          progressFill.style.width = progressPercent + "%";
          progressText.textContent = `Step ${oauthProgress + 1} of ${
            selectedCompanies.length
          }`;

          document.getElementById("oauthInstructions").innerHTML = `
        <strong>Next Company:</strong> ${companyName}<br>
        <small>When the Xero login opens, select "${companyName}" from the dropdown and authorize access.</small>
      `;
        }
      }

      function startNextOAuth() {
        if (oauthProgress >= selectedCompanies.length) {
          showCompletion();
          return;
        }

        const companyId = selectedCompanies[oauthProgress];
        const companyName = companies[companyId];

        localStorage.setItem("currentOAuthCompany", companyId);
        localStorage.setItem("currentOAuthCompanyName", companyName);

        isOAuthInProgress = true;
        document.getElementById("startOAuthBtn").style.display = "none";
        document.getElementById("waitingMessage").style.display = "block";

        window.location.href = "/auth";
      }

      async function checkOAuthStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          const currentCompanyName = localStorage.getItem(
            "currentOAuthCompanyName"
          );
          const currentCompanyId = localStorage.getItem("currentOAuthCompany");

          const newConnection = connections.find(
            (conn) => conn.tenantName === currentCompanyName && conn.connected
          );

          if (newConnection) {
            connectedCompanies.push({
              id: currentCompanyId,
              name: currentCompanyName,
              tenantId: newConnection.tenantId,
            });

            oauthProgress++;
            localStorage.setItem("oauthProgress", oauthProgress.toString());

            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";

            if (oauthProgress < selectedCompanies.length) {
              updateOAuthProgress();
              document.getElementById(
                "startOAuthBtn"
              ).textContent = `🔗 Connect Next Company (${oauthProgress + 1}/${
                selectedCompanies.length
              })`;
            } else {
              showCompletion();
            }
          } else {
            alert(`Failed to connect ${currentCompanyName}. Please try again.`);
            resetOAuthState();
          }
        } catch (error) {
          console.error("Error checking OAuth status:", error);
          alert("Error checking connection status. Please try again.");
          resetOAuthState();
        }
      }

      function resetOAuthState() {
        isOAuthInProgress = false;
        document.getElementById("startOAuthBtn").style.display = "inline-block";
        document.getElementById("waitingMessage").style.display = "none";
      }

      function showCompletion() {
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "block";
        document.getElementById("step2Indicator").classList.add("completed");
        document.getElementById("step2Indicator").classList.remove("active");
        document.getElementById("step3Indicator").classList.add("active");

        const connectedList = document.getElementById("connectedCompaniesList");
        connectedList.innerHTML = connectedCompanies
          .map(
            (company) => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #28a745; background: #f8fff9; border-radius: 6px; margin-bottom: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #28a745;"></div>
            <strong>${company.name}</strong>
          </div>
          <div style="color: #28a745; font-size: 0.9rem;">✅ Connected</div>
        </div>
      `
          )
          .join("");

        setTimeout(() => showMainDashboard(), 3000);
      }

      function showMainDashboard() {
        localStorage.removeItem("oauthCompanies");
        localStorage.removeItem("oauthProgress");
        localStorage.removeItem("currentOAuthCompany");
        localStorage.removeItem("currentOAuthCompanyName");
        localStorage.setItem("racCompaniesConnected", "true");

        document.getElementById("connectionManager").style.display = "none";
        document.getElementById("mainDashboard").style.display = "flex";

        initializeMainDashboard();
      }

      function handleOAuthReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.has("success");
        const isError = urlParams.has("error");
        const oauthCompanies = localStorage.getItem("oauthCompanies");

        if (isSuccess && oauthCompanies) {
          selectedCompanies = JSON.parse(oauthCompanies);
          oauthProgress = parseInt(localStorage.getItem("oauthProgress")) || 0;

          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";
          document.getElementById("step1Indicator").classList.add("completed");
          document.getElementById("step2Indicator").classList.add("active");

          setTimeout(() => checkOAuthStatus(), 1000);
        }

        if (isSuccess || isError) {
          history.replaceState({}, document.title, window.location.pathname);
        }
      }

      // ====== DASHBOARD INITIALIZATION ======

      // ====== REPLACE initializeMainDashboard() ======
      async function initializeMainDashboard() {
        try {
          selectedPeriod = getCurrentFiscalQuarter();

          await loadConnectedCompanies();
          setupCompanyFilters();

          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 60px; color: #666;">
        <h3>📊 RAC Financial Dashboard</h3>
        <p style="margin: 20px 0;">Select companies from the filters above, then click <strong>LOAD DATA</strong> to view financial information.</p>
        <p style="font-size: 14px; color: #999;">
          ${connectedCompanies.length} companies connected and ready
        </p>
      </div>
    `;

          updateLoadStatus();

          // ADD THIS: Apply saved scroll preference
          applySavedScrollMode();
        } catch (error) {
          console.error("Error initializing dashboard:", error);
        }
      }

      async function loadConnectedCompanies() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          connectedCompanies = connections.filter((conn) => conn.connected);
          activeCompanyFilters = connectedCompanies.map(
            (conn) => conn.tenantId
          );

          document.getElementById("connectedCount").textContent =
            connectedCompanies.length;

          const hasConnections = connectedCompanies.length > 0;
          document.getElementById(
            "dashboardStatus"
          ).className = `status-indicator ${
            hasConnections ? "balanced" : "imbalanced"
          }`;
        } catch (error) {
          console.error("Error loading connected companies:", error);
          connectedCompanies = [];
        }
      }

      // ====== REFRESH CONNECTION STATUS ======
      async function refreshConnectionStatus() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "⏳ Checking...";
        btn.disabled = true;

        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          // Update connected companies list
          connectedCompanies = connections.filter((conn) => conn.connected);

          // Find any selected companies that are no longer connected
          const disconnectedSelected = [];
          activeCompanyFilters.forEach((tenantId) => {
            const company = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!company) {
              const disconnected = connections.find(
                (c) => c.tenantId === tenantId
              );
              if (disconnected) {
                disconnectedSelected.push(disconnected.tenantName);
              }
            }
          });

          // Update UI
          setupCompanyFilters();
          document.getElementById("connectedCount").textContent =
            connectedCompanies.length;

          // Show alert if any selected companies are disconnected
          if (disconnectedSelected.length > 0) {
            alert(
              `⚠️ Connection expired for:\n\n${disconnectedSelected.join(
                "\n"
              )}\n\nPlease reconnect in Connection Manager.`
            );
          } else if (connectedCompanies.length > 0) {
            // Show success message
            const statusEl = document.getElementById("dataLoadStatus");
            if (statusEl) {
              statusEl.textContent = "✅ All connections active";
              statusEl.style.color = "#27ae60";
              setTimeout(() => {
                updateLoadStatus(); // Reset to normal message
              }, 3000);
            }
          }
        } catch (error) {
          console.error("Error checking connections:", error);
          alert("Failed to check connection status. Please try again.");
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
      // ====== REPLACE setupCompanyFilters() ======
      function setupCompanyFilters() {
        const filtersContainer = document.getElementById("companyFilters");

        if (connectedCompanies.length === 0) {
          filtersContainer.innerHTML =
            '<div style="color: #e74c3c;">No companies connected</div>';
          return;
        }

        // GET ALL POSSIBLE COMPANIES (connected + disconnected but selected)
        const allPossibleCompanies = [...connectedCompanies];

        // Add any previously selected but now disconnected companies
        activeCompanyFilters.forEach((tenantId) => {
          if (!connectedCompanies.find((c) => c.tenantId === tenantId)) {
            // This company was selected but is now disconnected
            allPossibleCompanies.push({
              tenantId: tenantId,
              tenantName: "Unknown Company",
              connected: false,
            });
          }
        });

        filtersContainer.innerHTML = `
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <!-- Helper buttons -->
      <button onclick="selectAllCompanies()" style="padding: 4px 8px; font-size: 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Select All
      </button>
      <button onclick="deselectAllCompanies()" style="padding: 4px 8px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Clear All
      </button>
      
      <!-- Separator -->
      <div style="border-left: 1px solid #ddd; height: 20px; margin: 0 5px;"></div>
      
      <!-- Company checkboxes with status indicators -->
      ${connectedCompanies
        .map((company) => {
          const shortName = company.tenantName
            .replace("Rirratjingu ", "")
            .replace(" Pty Ltd", "");
          const isChecked = activeCompanyFilters.includes(company.tenantId);
          const isConnected = company.connected !== false;
          const statusIcon = isConnected ? "🟢" : "🔴";
          const tooltip = isConnected
            ? "Connected"
            : "Connection expired - refresh needed";

          return `
          <div class="company-checkbox-item" title="${tooltip}">
            <input type="checkbox" 
                   id="filter-${company.tenantId}" 
                   ${isChecked ? "checked" : ""}
                   ${!isConnected ? "disabled" : ""}
                   onchange="handleCompanyFilterChange('${company.tenantId}')">
            <label for="filter-${company.tenantId}" 
                   style="color: white; ${!isConnected ? "opacity: 0.5;" : ""}"
                   onclick="toggleCompanyFilterByLabel('${company.tenantId}')">
              ${statusIcon} ${shortName}
            </label>
          </div>
        `;
        })
        .join("")}
      
      <!-- Separator -->
      <div style="border-left: 1px solid #ddd; height: 20px; margin: 0 5px;"></div>
      
      <!-- LOAD button -->
      <button id="loadDataBtn" onclick="loadDashboardData()" 
              style="padding: 6px 16px; font-size: 13px; font-weight: 600; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.background='#2980b9'" 
              onmouseout="this.style.background='#3498db'">
        🔄 LOAD DATA
      </button>
      
      <span id="dataLoadStatus" style="font-size: 12px; color: white; font-style: italic;"></span>
    </div>
  `;
      }

      // ====== REPLACE handleCompanyFilterChange() ======
      function handleCompanyFilterChange(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);

        if (checkbox.checked) {
          if (!activeCompanyFilters.includes(tenantId)) {
            activeCompanyFilters.push(tenantId);
          }
        } else {
          activeCompanyFilters = activeCompanyFilters.filter(
            (id) => id !== tenantId
          );
        }

        // Don't auto-reload - let user click LOAD button
        updateLoadStatus();
      }

      // ====== ADD NEW HELPER FUNCTIONS ======
      function selectAllCompanies() {
        activeCompanyFilters = connectedCompanies.map((c) => c.tenantId);
        connectedCompanies.forEach((company) => {
          document.getElementById(`filter-${company.tenantId}`).checked = true;
        });
        updateLoadStatus();
      }

      function deselectAllCompanies() {
        activeCompanyFilters = [];
        connectedCompanies.forEach((company) => {
          document.getElementById(`filter-${company.tenantId}`).checked = false;
        });
        updateLoadStatus();
      }

      function updateLoadStatus() {
        const statusEl = document.getElementById("dataLoadStatus");
        if (!statusEl) return; // Element not ready yet

        if (activeCompanyFilters.length === 0) {
          statusEl.textContent = "⚠️ No companies selected";
          statusEl.style.color = "#e74c3c";
        } else {
          statusEl.textContent = `${activeCompanyFilters.length} selected - click LOAD to refresh`;
          statusEl.style.color = "#f39c12";
        }
      }

      function toggleCompanyFilterByLabel(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event("change"));
      }

      function getSelectedCompanyNames() {
        return activeCompanyFilters.map((tenantId) => {
          const company = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          return company
            ? company.tenantName
                .replace("Rirratjingu ", "")
                .replace(" Pty Ltd", "")
            : "Unknown";
        });
      }

      function getOrganizationName(tenantName) {
        if (tenantName.includes("Mining")) return "Mining";
        if (tenantName.includes("Aboriginal Corporation"))
          return "Aboriginal Corporation";
        if (tenantName.includes("Property")) return "Property";
        if (tenantName.includes("Enterprises")) return "Enterprises";
        if (tenantName.includes("Invest")) return "Invest";
        if (tenantName.includes("Ngarrkuwuy")) return "Ngarrkuwuy";
        if (tenantName.includes("Marrin")) return "Marrin";
        return "Unknown";
      }

      function calculateGrowthRate(prior, current) {
        if (prior === 0 && current === 0) return 0;
        if (prior === 0) return current > 0 ? 100 : -100;
        return ((current - prior) / Math.abs(prior)) * 100;
      }

      function setView(view, button) {
        currentView = view;

        document
          .querySelectorAll(".toolbar button")
          .forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        loadDashboardData();
      }

      function backToConnections() {
        if (
          confirm(
            "Return to connection manager? This will allow you to modify your company connections."
          )
        ) {
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("connectionManager").style.display = "block";

          document.getElementById("step1").style.display = "block";
          document.getElementById("step2").style.display = "none";
          document.getElementById("step3").style.display = "none";

          document.getElementById("step1Indicator").className = "step active";
          document.getElementById("step2Indicator").className = "step";
          document.getElementById("step3Indicator").className = "step";

          loadSavedPreferences();
        }
      }

      // ====== PAGE INITIALIZATION ======

      async function initializePage() {
        handleOAuthReturn();

        if (localStorage.getItem("oauthCompanies")) {
          return;
        }

        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();
          const connectedCount = connections.filter(
            (conn) => conn.connected
          ).length;

          if (connectedCount > 0) {
            document.getElementById("connectionManager").style.display = "none";
            document.getElementById("mainDashboard").style.display = "block";
            initializeMainDashboard();
          } else {
            document.getElementById("connectionManager").style.display =
              "block";
            document.getElementById("mainDashboard").style.display = "none";
            loadSavedPreferences();
          }
        } catch (error) {
          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          loadSavedPreferences();
        }
      }

      // ====== EVENT LISTENERS ======

      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });

      window.addEventListener("popstate", handleOAuthReturn);

      /* ====== SECTION 4: DASHBOARD DATA LOADING FUNCTIONS ====== */
      /* MCP API integration and data visualization functions */

      // ====== MAIN DATA LOADING CONTROLLER ======

      async function loadDashboardData() {
        const dashboardElement = document.getElementById("dashboardData");

        // CHECK: No companies selected
        if (activeCompanyFilters.length === 0) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view financial data.</p>
      </div>
    `;
          return;
        }

        // NEW: CHECK connection status for selected companies
        const disconnectedSelected = [];
        for (const tenantId of activeCompanyFilters) {
          const company = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          if (!company || company.connected === false) {
            const companyName = company?.tenantName || "Unknown Company";
            disconnectedSelected.push(
              companyName.replace("Rirratjingu ", "").replace(" Pty Ltd", "")
            );
          }
        }

        if (disconnectedSelected.length > 0) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 20px; border-radius: 8px; max-width: 500px; margin: 0 auto;">
          <h3 style="color: #856404; margin-bottom: 15px;">⚠️ Connection Issue</h3>
          <p style="color: #856404; margin-bottom: 15px;">
            The following companies have expired connections:
          </p>
          <ul style="color: #856404; text-align: left; margin: 0 auto; display: inline-block;">
            ${disconnectedSelected
              .map((name) => `<li><strong>${name}</strong></li>`)
              .join("")}
          </ul>
          <p style="color: #856404; margin-top: 15px;">
            Please click <strong>"Check Connections"</strong> or <strong>"Manage Connections"</strong> to reconnect.
          </p>
          <button onclick="refreshConnectionStatus()" 
                  style="margin-top: 15px; padding: 10px 20px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
            🔄 Check Connections Now
          </button>
        </div>
      </div>
    `;
          return;
        }

        // Rest of your existing loadDashboardData() code continues...

        const selectedCompanyNames = getSelectedCompanyNames();

        // Build period selector HTML based on current view
        let periodSelectorHTML = "";

        if (
          currentView === "overview" ||
          currentView === "p-and-l" ||
          currentView === "cash-flow"
        ) {
          periodSelectorHTML = `
      <div style="background: #f8f9fa; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <label style="font-weight: 600; color: #2c3e50;">Period:</label>
            <select id="periodSelector" onchange="handlePeriodChange(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; font-size: 14px; cursor: pointer;">
            <option value="CurrentFY" ${
              selectedPeriod === "CurrentFY" ? "selected" : ""
            }>Current FY (YTD)</option>
          <option value="Q1" ${
            selectedPeriod === "Q1" ? "selected" : ""
          } ...>Q1 FY26 (Jul-Sep)</option>
              <option value="Q1" ${selectedPeriod === "Q1" ? "selected" : ""} ${
            !quarterHasData("Q1") ? 'disabled style="color: #ccc;"' : ""
          }>Q1 FY26 (Jul-Sep)</option>
              <option value="Q2" ${selectedPeriod === "Q2" ? "selected" : ""} ${
            !quarterHasData("Q2") ? 'disabled style="color: #ccc;"' : ""
          }>Q2 FY26 (Oct-Dec)</option>
              <option value="Q3" ${selectedPeriod === "Q3" ? "selected" : ""} ${
            !quarterHasData("Q3") ? 'disabled style="color: #ccc;"' : ""
          }>Q3 FY26 (Jan-Mar)</option>
              <option value="Q4" ${selectedPeriod === "Q4" ? "selected" : ""} ${
            !quarterHasData("Q4") ? 'disabled style="color: #ccc;"' : ""
          }>Q4 FY26 (Apr-Jun)</option>
              <option value="CM" ${
                selectedPeriod === "CM" ? "selected" : ""
              }>Current Month</option>
              <option value="LM" ${
                selectedPeriod === "LM" ? "selected" : ""
              }>Last Month</option>
            </select>
            <div style="color: #666; font-size: 13px;">
              ${getPeriodDates(selectedPeriod).label}
            </div>
          </div>
        </div>
      </div>
    `;
        }

        dashboardElement.innerHTML = `
    ${periodSelectorHTML}
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading ${currentView} data from ${
          activeCompanyFilters.length
        } companies:<br>
      <small>${selectedCompanyNames.join(", ")}</small>
    </div>
  `;

        try {
          switch (currentView) {
            case "overview":
              await loadOverviewDataWithYoY();
              break;
            case "trial-balance":
              await loadTrialBalanceData();
              break;
            case "cash-flow":
              await loadCashFlowData();
              break;
            case "p-and-l":
              await loadProfitLossData();
              break;
            case "year-over-year":
              await loadYearOverYearData();
              break;
            case "alerts":
              await loadAlertsData();
              break;
            default:
              await loadOverviewDataWithYoY();
          }
        } catch (error) {
          showErrorState(error);
        }
      }

      // ====== REPLACE handlePeriodChange() ======
      function handlePeriodChange(newPeriod) {
        selectedPeriod = newPeriod;
        // Don't auto-reload - let user click LOAD button
        updateLoadStatus();
      }

      function showErrorState(error) {
        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Data</h3>
        <p>Failed to load dashboard data: ${error.message}</p>
        <button onclick="loadDashboardData()" 
                style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
      }

      // ====== ENHANCED OVERVIEW WITH CONSOLIDATED METRICS ======

      async function loadOverviewDataWithYoY() {
        if (activeCompanyFilters.length === 0) {
          showNoCompaniesSelected();
          return;
        }

        try {
          const response = await fetch("/api/consolidated-trial-balance");
          const data = await response.json();

          const enhancedMetrics = [];
          const selectedCompanies = [];

          // Initialize consolidated budget structure
          let consolidatedBudget = {
            budget: {
              revenue: 0,
              operatingExpenses: 0,
            },
            actual: {
              revenue: 0,
              operatingExpenses: 0,
            },
            hasData: false,
            periodLabel: null,
            isProRated: false,
            daysElapsed: 0,
            totalDays: 0,
          };

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            let matchedCompany = findMatchedCompany(
              data.companies,
              tenantId,
              connectedCompany.tenantName
            );

            if (matchedCompany) {
              selectedCompanies.push(matchedCompany);

              try {
                const orgName = getOrganizationName(
                  connectedCompany.tenantName
                );
                const enhancedData = await loadEnhancedMetrics(
                  orgName,
                  connectedCompany,
                  matchedCompany,
                  tenantId
                );
                enhancedMetrics.push(enhancedData);

                // Load budget data for THIS company
                const periodDates = getPeriodDates(selectedPeriod);
                const companyBudget = await loadBudgetData(
                  orgName,
                  periodDates
                );

                // Add this company's budget to consolidated totals
                if (companyBudget) {
                  consolidatedBudget.hasData = true;
                  consolidatedBudget.budget.revenue +=
                    companyBudget.budget.revenue;
                  consolidatedBudget.budget.operatingExpenses +=
                    companyBudget.budget.operatingExpenses;

                  // Store period info from first company with budget
                  if (!consolidatedBudget.periodLabel) {
                    consolidatedBudget.periodLabel = companyBudget.periodLabel;
                    consolidatedBudget.isProRated = companyBudget.isProRated;
                    consolidatedBudget.daysElapsed = companyBudget.daysElapsed;
                    consolidatedBudget.totalDays = companyBudget.totalDays;
                  }
                }
              } catch (error) {
                console.error(
                  `Error loading enhanced metrics for ${connectedCompany.tenantName}:`,
                  error
                );
                enhancedMetrics.push(
                  createBasicMetrics(
                    connectedCompany,
                    matchedCompany,
                    tenantId,
                    true
                  )
                );
              }
            }
          }

          // Calculate consolidated variance if we have budget data
          if (
            consolidatedBudget.hasData &&
            consolidatedBudget.actual.revenue > 0
          ) {
            consolidatedBudget.variance = {
              revenue:
                consolidatedBudget.actual.revenue -
                consolidatedBudget.budget.revenue,
              revenuePercent:
                consolidatedBudget.budget.revenue > 0
                  ? ((consolidatedBudget.actual.revenue -
                      consolidatedBudget.budget.revenue) /
                      consolidatedBudget.budget.revenue) *
                    100
                  : 0,
              expenses:
                consolidatedBudget.actual.operatingExpenses -
                consolidatedBudget.budget.operatingExpenses,
              expensesPercent:
                consolidatedBudget.budget.operatingExpenses > 0
                  ? ((consolidatedBudget.actual.operatingExpenses -
                      consolidatedBudget.budget.operatingExpenses) /
                      consolidatedBudget.budget.operatingExpenses) *
                    100
                  : 0,
            };
          }

          const consolidatedTotals =
            calculateConsolidatedTotals(enhancedMetrics);
          const balancedCompanies = enhancedMetrics.filter(
            (c) => !c.error && c.balanced
          ).length;

          // Calculate budget variance using actuals from performance data
          if (consolidatedBudget.hasData) {
            consolidatedBudget.actual = {
              revenue: consolidatedTotals.totalRevenue,
              operatingExpenses:
                consolidatedTotals.totalRevenue -
                consolidatedTotals.totalProfit,
            };

            consolidatedBudget.variance = {
              revenue:
                consolidatedBudget.actual.revenue -
                consolidatedBudget.budget.revenue,
              revenuePercent:
                consolidatedBudget.budget.revenue > 0
                  ? ((consolidatedBudget.actual.revenue -
                      consolidatedBudget.budget.revenue) /
                      consolidatedBudget.budget.revenue) *
                    100
                  : 0,
              expenses:
                consolidatedBudget.actual.operatingExpenses -
                consolidatedBudget.budget.operatingExpenses,
              expensesPercent:
                consolidatedBudget.budget.operatingExpenses > 0
                  ? ((consolidatedBudget.actual.operatingExpenses -
                      consolidatedBudget.budget.operatingExpenses) /
                      consolidatedBudget.budget.operatingExpenses) *
                    100
                  : 0,
            };
          }

          renderEnhancedOverview(
            consolidatedTotals,
            enhancedMetrics,
            balancedCompanies,
            consolidatedBudget.hasData ? consolidatedBudget : null
          );
        } catch (error) {
          console.error("Error in enhanced loadOverviewDataWithYoY:", error);
          showErrorState(error);
        }
      }

      function findMatchedCompany(companies, tenantId, tenantName) {
        let matchedCompany = companies?.find(
          (company) => company.tenantId === tenantId
        );

        if (!matchedCompany) {
          matchedCompany = companies?.find((company) => {
            const companyName = company.tenantName.toLowerCase();
            const targetName = tenantName.toLowerCase();
            return (
              (companyName.includes("mining") &&
                targetName.includes("mining")) ||
              (companyName.includes("aboriginal") &&
                targetName.includes("aboriginal")) ||
              (companyName.includes("property") &&
                targetName.includes("property"))
            );
          });
        }

        return matchedCompany;
      }

      async function loadEnhancedMetrics(
        orgName,
        connectedCompany,
        matchedCompany,
        tenantId
      ) {
        const periodDates = getPeriodDates(selectedPeriod); // ADD THIS LINE

        const [cashResponse, ratiosResponse, profitLossResponse] =
          await Promise.all([
            fetchWithErrorHandling("/api/cash-position", {
              organizationName: orgName,
            }),
            fetchWithErrorHandling("/api/financial-ratios", {
              organizationName: orgName,
            }),
            fetchWithErrorHandling("/api/profit-loss-summary", {
              organizationName: orgName,
              date: periodDates.periodEnd, // ADD THIS
              periodMonths: periodDates.months, // ADD THIS
            }),
          ]);

        const cashData = cashResponse?.ok ? await cashResponse.json() : null;
        const ratiosData = ratiosResponse?.ok
          ? await ratiosResponse.json()
          : null;
        const profitLossData = profitLossResponse?.ok
          ? await profitLossResponse.json()
          : null;

        return {
          tenantId,
          companyName: connectedCompany.tenantName,
          totalAssets: matchedCompany.totals?.totalAssets || 0,
          totalLiabilities: Math.abs(
            matchedCompany.totals?.totalLiabilities || 0
          ),
          totalEquity: matchedCompany.totals?.totalEquity || 0,
          balanced: matchedCompany.balanceCheck?.debitsEqualCredits || false,
          cashPosition: cashData?.totalCash || 0,
          currentRatio: ratiosData?.ratios?.liquidity?.currentRatio || 0,
          debtToEquity: ratiosData?.ratios?.leverage?.debtToEquity || 0,
          netProfitMargin:
            ratiosData?.ratios?.profitability?.netProfitMargin || 0,
          returnOnAssets:
            ratiosData?.ratios?.profitability?.returnOnAssets || 0,
          revenue: profitLossData?.summary?.totalRevenue || 0,
          netProfit: profitLossData?.summary?.netProfit || 0,
          error: false,
        };
      }

      function createBasicMetrics(
        connectedCompany,
        matchedCompany,
        tenantId,
        hasError = false
      ) {
        return {
          tenantId,
          companyName: connectedCompany.tenantName,
          totalAssets: matchedCompany.totals?.totalAssets || 0,
          totalLiabilities: Math.abs(
            matchedCompany.totals?.totalLiabilities || 0
          ),
          totalEquity: matchedCompany.totals?.totalEquity || 0,
          balanced: matchedCompany.balanceCheck?.debitsEqualCredits || false,
          error: hasError,
        };
      }

      function calculateConsolidatedTotals(enhancedMetrics) {
        const totals = enhancedMetrics.reduce(
          (acc, company) => {
            if (company.error) return acc;
            acc.totalAssets += company.totalAssets || 0;
            acc.totalLiabilities += company.totalLiabilities || 0;
            acc.totalEquity += company.totalEquity || 0;
            acc.totalCash += company.cashPosition || 0;
            acc.totalRevenue += company.revenue || 0;
            acc.totalProfit += company.netProfit || 0;
            return acc;
          },
          {
            totalAssets: 0,
            totalLiabilities: 0,
            totalEquity: 0,
            totalCash: 0,
            totalRevenue: 0,
            totalProfit: 0,
          }
        );

        // Calculate derived metrics
        totals.profitMargin =
          totals.totalRevenue !== 0
            ? (totals.totalProfit / totals.totalRevenue) * 100 // Remove .toFixed(1)
            : 0;

        totals.debtToEquityRatio =
          totals.totalEquity !== 0
            ? totals.totalLiabilities / totals.totalEquity // Remove .toFixed(2)
            : 0;

        return totals;
      }

      // ====== BUDGET DATA LOADING ======
      async function loadBudgetData(organizationName, periodDates) {
        try {
          const budgetQuarter = periodDates.quarter || "Q1";
          const budgetQuarterDates = getQuarterDates(budgetQuarter);

          // Calculate yesterday's date
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);

          const periodStart = new Date(periodDates.start);

          // Only load BUDGET data
          const budgetResponse = await fetchWithErrorHandling(
            "/api/budget-summary",
            {
              organizationName: organizationName,
              date: budgetQuarterDates.start,
              periods: 3,
            }
          );

          if (!budgetResponse || !budgetResponse.ok) {
            console.log("Budget data not available for", organizationName);
            return null;
          }

          const budgetData = await budgetResponse.json();

          // Parse budget data
          const budgetSummary = parseBudgetReport(
            budgetData.report,
            budgetQuarter
          );

          if (!budgetSummary) {
            return null;
          }

          // Store quarterly budget
          budgetSummary.quarterlyBudget = {
            revenue: budgetSummary.budget.revenue,
            operatingExpenses: budgetSummary.budget.operatingExpenses,
          };

          // Calculate days elapsed from period start to yesterday
          // Calculate days elapsed ONLY if period is incomplete
          let daysElapsed = 0;
          const periodEndDate = new Date(periodDates.periodEnd);

          if (yesterday >= periodStart && yesterday < periodEndDate) {
            // Period is in progress - calculate pro-rating
            const startMidnight = new Date(
              periodStart.getFullYear(),
              periodStart.getMonth(),
              periodStart.getDate()
            );
            const yesterdayMidnight = new Date(
              yesterday.getFullYear(),
              yesterday.getMonth(),
              yesterday.getDate()
            );
            const diffTime = yesterdayMidnight - startMidnight;
            daysElapsed = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
          }

          // Pro-rate budget based on elapsed days
          if (periodDates.months < 3) {
            budgetSummary.budget.revenue = budgetSummary.budget.revenue / 3;
            budgetSummary.budget.operatingExpenses =
              budgetSummary.budget.operatingExpenses / 3;
            budgetSummary.isProRated = true;
            budgetSummary.proRateMethod = "monthly";
          } else if (
            daysElapsed > 0 &&
            daysElapsed < periodDates.daysInPeriod
          ) {
            budgetSummary.budget.revenue = calculateProRatedBudget(
              budgetSummary.budget.revenue,
              periodDates.daysInPeriod,
              daysElapsed
            );
            budgetSummary.budget.operatingExpenses = calculateProRatedBudget(
              budgetSummary.budget.operatingExpenses,
              periodDates.daysInPeriod,
              daysElapsed
            );
            budgetSummary.isProRated = true;
            budgetSummary.proRateMethod = "daily";
            budgetSummary.daysElapsed = daysElapsed;
            budgetSummary.totalDays = periodDates.daysInPeriod;
          }

          budgetSummary.periodLabel = periodDates.label;

          return budgetSummary;
        } catch (error) {
          console.error("Error loading budget data:", error);
          return null;
        }
      }

      function parseBudgetReport(report, quarter) {
        if (!report || !report.rows) {
          return null;
        }

        // When requesting 3 periods, the API returns just those 3 months
        // Always in cells [1, 2, 3] regardless of which quarter
        const columns = [1, 2, 3];

        const summary = {
          budget: {
            revenue: 0,
            operatingExpenses: 0,
          },
          actual: null,
          variance: null,
        };

        // Parse sections - ONLY use the summary row totals
        for (const section of report.rows) {
          if (section.rowType === "Section") {
            if (section.title === "Income") {
              const totalRow = section.rows.find(
                (r) =>
                  r.rowType === "SummaryRow" &&
                  r.cells[0].value === "Total Income"
              );

              if (totalRow) {
                summary.budget.revenue =
                  parseFloat(totalRow.cells[1]?.value || 0) +
                  parseFloat(totalRow.cells[2]?.value || 0) +
                  parseFloat(totalRow.cells[3]?.value || 0);
              }
            } else if (section.title === "Less Operating Expenses") {
              const totalRow = section.rows.find(
                (r) =>
                  r.rowType === "SummaryRow" &&
                  r.cells[0].value === "Total Operating Expenses"
              );

              if (totalRow) {
                summary.budget.operatingExpenses =
                  Math.abs(parseFloat(totalRow.cells[1]?.value || 0)) +
                  Math.abs(parseFloat(totalRow.cells[2]?.value || 0)) +
                  Math.abs(parseFloat(totalRow.cells[3]?.value || 0));
              }
            }
          }
        }

        return summary;
      }

      function createMetric(label, value, isNegative = false, id = "") {
        return `
    <div class="metric">
      <span>${label}</span>
      <span class="metric-value ${isNegative ? "negative" : ""}" ${
          id ? `id="${id}"` : ""
        }>${value}</span>
    </div>
  `;
      }

      function renderEnhancedOverview(
        totals,
        enhancedMetrics,
        balancedCompanies,
        budgetData
      ) {
        const periodDates = getPeriodDates(selectedPeriod);
        const dashboardElement = document.getElementById("dashboardData");

        dashboardElement.innerHTML = `
    <!-- ENHANCED FINANCIAL OVERVIEW -->
    <div class="dashboard-grid" style="grid-template-columns: repeat(5, 1fr);">
      
      <!-- Card 1: Financial Position -->
      <div class="dashboard-card">
        <h3>📊 ${periodDates.label} Financial Position</h3>
        ${createMetric(
          "Total Assets",
          `$${totals.totalAssets.toLocaleString()}`
        )}
        ${createMetric(
          "Total Liabilities",
          `$${totals.totalLiabilities.toLocaleString()}`
        )}
        ${createMetric("Net Equity", `$${totals.totalEquity.toLocaleString()}`)}
        ${createMetric(
          "Net Worth",
          `$${(totals.totalAssets - totals.totalLiabilities).toLocaleString()}`
        )}
      </div>

      <!-- Card 2: Performance -->
      <div class="dashboard-card">
        <h3>🔥 ${periodDates.label} Performance</h3>
        ${createMetric(
          "Total Cash Position",
          `$${totals.totalCash.toLocaleString()}`
        )}
        ${createMetric(
          "Annual Revenue",
          `$${totals.totalRevenue.toLocaleString()}`
        )}
        ${createMetric(
          "Net Profit",
          `$${totals.totalProfit.toLocaleString()}`,
          totals.totalProfit < 0
        )}
        ${createMetric(
          "Profit Margin",
          `${totals.profitMargin.toFixed(1)}%`,
          totals.totalProfit < 0
        )}
      </div>

      <!-- Card 3: Health & Risk -->
      <div class="dashboard-card">
        <h3>⚕️ ${periodDates.label} Health & Risk</h3>
        ${createMetric("Companies", enhancedMetrics.length)}
        ${createMetric(
          "Balanced Books",
          `${balancedCompanies}/${enhancedMetrics.length}`
        )}
        ${createMetric(
          "Debt/Equity Ratio",
          totals.debtToEquityRatio
            ? totals.debtToEquityRatio.toFixed(2)
            : "0.00"
        )}
        <div class="status-badge ${
          balancedCompanies === enhancedMetrics.length ? "healthy" : "warning"
        }">
          ${
            balancedCompanies === enhancedMetrics.length
              ? "✅ Healthy"
              : "⚠️ Review Needed"
          }
        </div>
      </div>

      <!-- Card 4: Revenue Budget -->
      <div class="dashboard-card" id="revenueBudgetCard">
        <h3>💵 Revenue vs Budget</h3>
        <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;" id="revenuePeriodLabel">${
          periodDates.label
        }</div>
        ${createMetric("Budget", "$0", false, "revenueBudget")}
        ${createMetric("Actual", "$0", false, "revenueActual")}
        ${createMetric("Variance", "$0 (0%)", false, "revenueVariance")}
      </div>

      <!-- Card 5: Expenses Budget -->
      <div class="dashboard-card" id="expensesBudgetCard">
        <h3>💳 Expenses vs Budget</h3>
        <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;" id="expensesPeriodLabel">${
          periodDates.label
        }</div>
        ${createMetric("Budget", "$0", false, "expensesBudget")}
        ${createMetric("Actual", "$0", false, "expensesActual")}
        ${createMetric("Variance", "$0 (0%)", false, "expensesVariance")}
      </div>

    </div>

<!-- VERTICAL BAR CHARTS - One for each card above -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
  
  <!-- Chart 1: Financial Position -->
  <div class="dashboard-card" style="min-height: 300px;">
    <h4 style="font-size: 13px; margin-bottom: 10px; text-align: center;">Financial Position</h4>
    <div id="chart-financial-position" style="display: flex; gap: 5px; align-items: flex-end; height: 240px; padding: 10px;">
      <!-- Chart will be inserted here -->
    </div>
  </div>

  <!-- Chart 2: Performance -->
  <div class="dashboard-card" style="min-height: 300px;">
    <h4 style="font-size: 13px; margin-bottom: 10px; text-align: center;">Performance</h4>
    <div id="chart-performance" style="display: flex; gap: 5px; align-items: flex-end; height: 240px; padding: 10px;">
      <!-- Chart will be inserted here -->
    </div>
  </div>

  <!-- Chart 3: Health & Risk -->
  <div class="dashboard-card" style="min-height: 300px;">
    <h4 style="font-size: 13px; margin-bottom: 10px; text-align: center;">Health & Risk</h4>
    <div id="chart-health-risk" style="display: flex; gap: 5px; align-items: flex-end; height: 240px; padding: 10px;">
      <!-- Chart will be inserted here -->
    </div>
  </div>

  <!-- Chart 4: Revenue vs Budget -->
  <div class="dashboard-card" style="min-height: 300px;">
    <h4 style="font-size: 13px; margin-bottom: 10px; text-align: center;">Revenue vs Budget</h4>
    <div id="chart-revenue-budget" style="display: flex; gap: 5px; align-items: flex-end; height: 240px; padding: 10px;">
      <!-- Chart will be inserted here -->
    </div>
  </div>

  <!-- Chart 5: Expenses vs Budget -->
  <div class="dashboard-card" style="min-height: 300px;">
    <h4 style="font-size: 13px; margin-bottom: 10px; text-align: center;">Expenses vs Budget</h4>
    <div id="chart-expenses-budget" style="display: flex; gap: 5px; align-items: flex-end; height: 240px; padding: 10px;">
      <!-- Chart will be inserted here -->
    </div>
  </div>

</div>

<!-- COMPANY BREAKDOWN -->
<div class="dashboard-card" style="grid-column: 1 / -1;">
  <h3>📈 ${periodDates.label} Company Performance</h3>
  <div style="padding-right: 10px;">
    ${enhancedMetrics.map((company) => createCompanyCard(company)).join("")}
  </div>
</div>

    `;

        // UPDATE BUDGET CARDS WITH REAL DATA
        if (budgetData) {
          updateBudgetCardValues(budgetData, periodDates);
        }

        // RENDER VERTICAL BAR CHARTS
        renderVerticalBarCharts(totals, budgetData);

        // APPLY SAVED SCROLL MODE
        setTimeout(() => applySavedScrollMode(), 100);

        // ====== ADD updateBudgetCardValues() function (with fixes from earlier) ======
        function updateBudgetCardValues(budgetData, periodDates) {
          if (!budgetData || !budgetData.budget) return;

          const budget = budgetData.budget;
          const actual = budgetData.actual;
          const variance = budgetData.variance;

          // Update period labels with pro-rating info OR standard label
          if (budgetData.isProRated && budgetData.daysElapsed) {
            const proRateText = `${periodDates.label} (Pro-rated: ${budgetData.daysElapsed} of ${budgetData.totalDays} days)`;
            document.getElementById("revenuePeriodLabel").textContent =
              proRateText;
            document.getElementById("expensesPeriodLabel").textContent =
              proRateText;
          } else {
            // Complete period - no pro-rating
            document.getElementById("revenuePeriodLabel").textContent =
              periodDates.label;
            document.getElementById("expensesPeriodLabel").textContent =
              periodDates.label;
          }

          // ... rest of function stays the same

          // Update revenue card
          document.getElementById("revenueBudget").textContent = `$${Math.round(
            budget.revenue
          ).toLocaleString()}`;
          if (actual) {
            document.getElementById(
              "revenueActual"
            ).textContent = `$${Math.round(actual.revenue).toLocaleString()}`;
            const varianceEl = document.getElementById("revenueVariance");
            varianceEl.innerHTML = `${
              variance.revenue >= 0 ? "+" : ""
            }$${Math.round(
              Math.abs(variance.revenue)
            ).toLocaleString()}<br><span style="font-size: 0.9em; margin-top: 4px; display: block;">(${
              variance.revenuePercent >= 0 ? "+" : ""
            }${variance.revenuePercent.toFixed(1)}%)</span>`;
            varianceEl.className =
              variance.revenue >= 0 ? "metric-value" : "metric-value negative";
          }

          // Update expenses card
          document.getElementById(
            "expensesBudget"
          ).textContent = `$${Math.round(
            budget.operatingExpenses
          ).toLocaleString()}`;
          if (actual) {
            document.getElementById(
              "expensesActual"
            ).textContent = `$${Math.round(
              actual.operatingExpenses
            ).toLocaleString()}`;
            const varianceEl = document.getElementById("expensesVariance");
            varianceEl.innerHTML = `${
              variance.expenses >= 0 ? "+" : ""
            }$${Math.round(
              Math.abs(variance.expenses)
            ).toLocaleString()}<br><span style="font-size: 0.9em; margin-top: 4px; display: block;">(${
              variance.expensesPercent >= 0 ? "+" : ""
            }${variance.expensesPercent.toFixed(1)}%)</span>`;
            varianceEl.className =
              variance.expenses <= 0 ? "metric-value" : "metric-value negative";
          }
        }

        // ====== RENDER VERTICAL BAR CHARTS ======
        function renderVerticalBarCharts(totals, budgetData) {
          // Chart 1: Financial Position (Assets, Liabilities, Net Worth)
          renderChart("chart-financial-position", [
            { label: "Assets", value: totals.totalAssets, color: "#27ae60" },
            {
              label: "Liabilities",
              value: totals.totalLiabilities,
              color: "#e74c3c",
            },
            {
              label: "Net Worth",
              value: totals.totalAssets - totals.totalLiabilities,
              color: "#3498db",
            },
          ]);

          // Chart 2: Performance (Revenue, Expenses, Profit)
          const expenses = totals.totalRevenue - totals.totalProfit;
          renderChart("chart-performance", [
            { label: "Revenue", value: totals.totalRevenue, color: "#27ae60" },
            { label: "Expenses", value: expenses, color: "#e74c3c" },
            {
              label: "Profit",
              value: totals.totalProfit,
              color: totals.totalProfit >= 0 ? "#3498db" : "#e74c3c",
            },
          ]);

          // Chart 3: Health & Risk (Balanced vs Imbalanced companies)
          const balancedMetrics = document.querySelectorAll(".metric");
          let balanced = 0,
            total = 0;
          balancedMetrics.forEach((metric) => {
            if (metric.textContent.includes("Balanced Books")) {
              const text =
                metric.querySelector(".metric-value")?.textContent || "0/0";
              [balanced, total] = text.split("/").map((n) => parseInt(n) || 0);
            }
          });
          const imbalanced = total - balanced;

          renderChart(
            "chart-health-risk",
            [
              { label: "Balanced", value: balanced, color: "#27ae60" },
              { label: "Imbalanced", value: imbalanced, color: "#e74c3c" },
            ],
            true
          );

          // Chart 4: Revenue vs Budget
          if (budgetData && budgetData.budget) {
            renderChart("chart-revenue-budget", [
              {
                label: "Budget",
                value: budgetData.budget.revenue,
                color: "#3498db",
              },
              {
                label: "Actual",
                value: budgetData.actual.revenue,
                color:
                  budgetData.actual.revenue >= budgetData.budget.revenue
                    ? "#27ae60"
                    : "#e74c3c",
              },
            ]);
          }

          // Chart 5: Expenses vs Budget
          if (budgetData && budgetData.budget) {
            renderChart("chart-expenses-budget", [
              {
                label: "Budget",
                value: budgetData.budget.operatingExpenses,
                color: "#95a5a6",
              },
              {
                label: "Actual",
                value: budgetData.actual.operatingExpenses,
                color:
                  budgetData.actual.operatingExpenses <=
                  budgetData.budget.operatingExpenses
                    ? "#27ae60"
                    : "#e74c3c",
              },
            ]);
          }
        }

        // ====== GENERIC CHART RENDERING FUNCTION ======

        function renderChart(containerId, data, isCountMode = false) {
          const container = document.getElementById(containerId);
          if (!container) return;

          const maxValue = Math.max(...data.map((d) => Math.abs(d.value)));
          if (maxValue === 0) {
            container.innerHTML =
              '<div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">No data</div>';
            return;
          }

          // Get the actual available height for bars (container height minus space for labels)
          const containerHeight = 240; // matches the container height
          const labelSpace = 60; // space for value label + text label
          const availableHeight = containerHeight - labelSpace;

          container.innerHTML = data
            .map((item) => {
              // Calculate actual pixel height based on available space
              const barHeightPx = Math.max(
                (Math.abs(item.value) / maxValue) * availableHeight,
                5
              );

              // Format display value
              const displayValue = isCountMode
                ? item.value
                : item.value >= 1000000
                ? `$${(item.value / 1000000).toFixed(1)}M`
                : item.value >= 1000
                ? `$${(item.value / 1000).toFixed(0)}K`
                : `$${item.value.toFixed(0)}`;

              return `
      <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: ${containerHeight}px;">
        <div style="font-size: 11px; font-weight: 600; color: ${item.color}; margin-bottom: 4px; white-space: nowrap;">
          ${displayValue}
        </div>
        <div style="
          width: 60px; 
          height: ${barHeightPx}px; 
          background: linear-gradient(to top, ${item.color}, ${item.color}dd); 
          border-radius: 4px 4px 0 0; 
          transition: all 0.3s ease; 
          box-shadow: 0 2px 4px rgba(0,0,0,0.15);
          border: 1px solid ${item.color};
        "></div>
        <div style="font-size: 10px; color: #666; margin-top: 6px; text-align: center; line-height: 1.2; font-weight: 500;">
          ${item.label}
        </div>
      </div>
    `;
            })
            .join("");
        }
      }

      function renderBudgetVarianceChart(budgetData) {
        if (!budgetData || !budgetData.variance) return;

        const container = document.getElementById("budgetVarianceChart");
        if (!container) return;

        const revenueVariance = budgetData.variance.revenue;
        const expenseVariance = -budgetData.variance.expenses; // Negative because under budget is good

        const chartData = [
          {
            name: "Revenue Budget",
            value: budgetData.budget.revenue,
            fill: "#3498db",
          },
          {
            name: "Revenue Variance",
            value: revenueVariance,
            fill: revenueVariance >= 0 ? "#2ecc71" : "#e74c3c",
          },
          {
            name: "Expense Budget",
            value: budgetData.budget.operatingExpenses,
            fill: "#95a5a6",
          },
          {
            name: "Expense Variance",
            value: expenseVariance,
            fill: expenseVariance >= 0 ? "#2ecc71" : "#e74c3c",
          },
        ];

        // Simple HTML bar chart (no external libraries needed)
        const maxValue = Math.max(...chartData.map((d) => Math.abs(d.value)));

        container.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 15px; padding: 10px;">
      ${chartData
        .map(
          (item) => `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="min-width: 120px; font-size: 12px; font-weight: 500;">${
            item.name
          }</div>
          <div style="flex: 1; height: 30px; background: #f0f0f0; border-radius: 4px; position: relative; overflow: hidden;">
            <div style="width: ${
              (Math.abs(item.value) / maxValue) * 100
            }%; height: 100%; background: ${
            item.fill
          }; transition: width 0.5s;"></div>
          </div>
          <div style="min-width: 100px; text-align: right; font-size: 13px; font-weight: 600; color: ${
            item.fill
          };">
            ${item.value >= 0 ? "+" : ""}$${Math.round(
            item.value
          ).toLocaleString()}
          </div>
        </div>
      `
        )
        .join("")}
    </div>
  `;
      }

      function createCompanyCard(company) {
        return `
      <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin: 10px 0; background: ${
        company.balanced ? "#f8fff8" : "#fff8f8"
      };">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong style="font-size: 16px;">${company.companyName.replace(
            "Rirratjingu ",
            ""
          )}</strong>
          <span class="metric-value ${
            company.error ? "negative" : company.balanced ? "" : "negative"
          }" style="font-size: 14px;">
            ${
              company.error
                ? "⚠️ Data Error"
                : company.balanced
                ? "✅ Balanced"
                : "❌ Imbalanced"
            }
          </span>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px;">
          ${createCompanyMetric("Assets", company.totalAssets)}
          ${createCompanyMetric("Revenue", company.revenue)}
          ${createCompanyMetric(
            "Net Profit",
            company.netProfit,
            company.netProfit < 0
          )}
          ${createCompanyMetric(
            "Profit Margin",
            `${(company.netProfitMargin || 0).toFixed(1)}%`
          )}
        </div>

        ${
          !company.error
            ? `
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
            ${createCompanyMetric("Cash Position", company.cashPosition)}
            ${createCompanyMetric(
              "Current Ratio",
              (company.currentRatio || 0).toFixed(2)
            )}
            ${createCompanyMetric(
              "ROA",
              `${(company.returnOnAssets || 0).toFixed(1)}%`
            )}
            ${createCompanyMetric(
              "D/E Ratio",
              (company.debtToEquity || 0).toFixed(2)
            )}
          </div>
        `
            : ""
        }
      </div>
    `;
      }

      function createCompanyMetric(label, value, isNegative = false) {
        const displayValue =
          typeof value === "number" ? value.toLocaleString() : value;
        const formattedValue =
          typeof value === "number" && value >= 1000
            ? `$${displayValue}`
            : displayValue;

        return `
      <div>
        <div style="color: #666; margin-bottom: 3px;">${label}</div>
        <div style="font-weight: 600; color: ${
          isNegative ? "#e74c3c" : "#27ae60"
        };">${formattedValue}</div>
      </div>
    `;
      }

      // ====== BUDGET CARD CREATION ======
      function createBudgetCard(budgetData) {
        if (!budgetData || !budgetData.budget) {
          return "";
        }

        const budget = budgetData.budget;
        const actual = budgetData.actual;
        const variance = budgetData.variance;

        // Determine status colors
        const revenueStatus =
          variance && variance.revenue < 0 ? "under" : "over";
        const expenseStatus =
          variance && variance.expenses > 0 ? "over" : "under";

        const revenueColor = revenueStatus === "under" ? "#e74c3c" : "#27ae60";
        const expenseColor = expenseStatus === "over" ? "#e74c3c" : "#27ae60";

        return `
    <!-- BUDGET VS ACTUAL CARD -->
    <div class="dashboard-card" style="margin: 20px 0; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
      <h3>💼 ${budgetData.periodLabel} Budget Performance</h3>
<div style="font-size: 13px; color: #666; margin-bottom: 15px;">
  ${
    budgetData.isProRated
      ? `
    <span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px; font-size: 12px;">
      ⚠️ Budget ${
        budgetData.proRateMethod === "monthly"
          ? "pro-rated from quarterly budget (÷3)"
          : `pro-rated: ${budgetData.daysElapsed} of ${budgetData.totalDays} days`
      }
    </span>
  `
      : "Full period budget"
  }
</div>

      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        
        <!-- REVENUE SECTION -->
        <div style="border: 1px solid ${revenueColor}; border-radius: 8px; padding: 15px; background: ${
          revenueStatus === "under" ? "#fff8f8" : "#f8fff8"
        };">
          <h4 style="color: ${revenueColor}; margin-bottom: 12px; border-bottom: 2px solid ${revenueColor}; padding-bottom: 6px;">
            📈 Revenue
          </h4>
          
          <div style="display: grid; gap: 10px; font-size: 13px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #666;">Budget:</span>
              <span style="font-weight: 600;">$${budget.revenue.toLocaleString()}</span>
            </div>
            
            ${
              actual
                ? `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #666;">Actual:</span>
                <span style="font-weight: 600;">$${actual.revenue.toLocaleString()}</span>
              </div>
              
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                  <span style="font-weight: 600; color: ${revenueColor};">Variance:</span>
                  <span style="font-weight: 700; color: ${revenueColor}; font-size: 15px;">
                    ${variance.revenue >= 0 ? "+" : ""}$${Math.abs(
                    variance.revenue
                  ).toLocaleString()}
                  </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #666;">Percentage:</span>
                  <span style="font-weight: 600; color: ${revenueColor};">
                    ${
                      variance.revenuePercent >= 0 ? "+" : ""
                    }${variance.revenuePercent.toFixed(1)}%
                  </span>
                </div>
              </div>

              <div style="margin-top: 10px; padding: 8px; background: ${
                revenueStatus === "under" ? "#fee" : "#efe"
              }; border-radius: 4px; text-align: center; font-size: 12px; font-weight: 500; color: ${revenueColor};">
                ${
                  revenueStatus === "under"
                    ? `⚠️ ${Math.abs(variance.revenuePercent).toFixed(
                        0
                      )}% UNDER Budget`
                    : `✅ ${variance.revenuePercent.toFixed(0)}% OVER Budget`
                }
              </div>
            `
                : `
              <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; text-align: center; font-size: 12px; color: #856404;">
                ℹ️ Actual data not available
              </div>
            `
            }
          </div>
        </div>

        <!-- EXPENSES SECTION -->
        <div style="border: 1px solid ${expenseColor}; border-radius: 8px; padding: 15px; background: ${
          expenseStatus === "over" ? "#fff8f8" : "#f8fff8"
        };">
          <h4 style="color: ${expenseColor}; margin-bottom: 12px; border-bottom: 2px solid ${expenseColor}; padding-bottom: 6px;">
            📉 Operating Expenses
          </h4>
          
          <div style="display: grid; gap: 10px; font-size: 13px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #666;">Budget:</span>
              <span style="font-weight: 600;">$${budget.operatingExpenses.toLocaleString()}</span>
            </div>
            
            ${
              actual
                ? `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #666;">Actual:</span>
                <span style="font-weight: 600;">$${actual.operatingExpenses.toLocaleString()}</span>
              </div>
              
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                  <span style="font-weight: 600; color: ${expenseColor};">Variance:</span>
                  <span style="font-weight: 700; color: ${expenseColor}; font-size: 15px;">
                    ${variance.expenses >= 0 ? "+" : ""}$${Math.abs(
                    variance.expenses
                  ).toLocaleString()}
                  </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #666;">Percentage:</span>
                  <span style="font-weight: 600; color: ${expenseColor};">
                    ${
                      variance.expensesPercent >= 0 ? "+" : ""
                    }${variance.expensesPercent.toFixed(1)}%
                  </span>
                </div>
              </div>

              <div style="margin-top: 10px; padding: 8px; background: ${
                expenseStatus === "over" ? "#fee" : "#efe"
              }; border-radius: 4px; text-align: center; font-size: 12px; font-weight: 500; color: ${expenseColor};">
                ${
                  expenseStatus === "over"
                    ? `⚠️ ${variance.expensesPercent.toFixed(0)}% OVER Budget`
                    : `✅ ${Math.abs(variance.expensesPercent).toFixed(
                        0
                      )}% UNDER Budget`
                }
              </div>
            `
                : `
              <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; text-align: center; font-size: 12px; color: #856404;">
                ℹ️ Actual data not available
              </div>
            `
            }
          </div>
        </div>
      </div>

      ${
        variance
          ? `
        <!-- BUDGET INSIGHTS -->
        <div style="margin-top: 20px; padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
          <h5 style="color: #0c5460; margin-bottom: 10px;">💡 Budget Performance Insights</h5>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 13px;">
            <div>
              <strong>Overall Budget Status:</strong>
              <div style="margin-top: 5px;">
                ${
                  revenueStatus === "under" && expenseStatus === "under"
                    ? "Revenue below target but expenses well controlled - focus on revenue growth"
                    : revenueStatus === "over" && expenseStatus === "under"
                    ? "Excellent performance - revenue exceeding budget with controlled expenses"
                    : revenueStatus === "under" && expenseStatus === "over"
                    ? "⚠️ Critical - Both revenue under and expenses over budget"
                    : "Revenue strong but expenses need attention - monitor cost control"
                }
              </div>
            </div>
            <div>
              <strong>Key Finding:</strong>
              <div style="margin-top: 5px; color: #e74c3c; font-weight: 500;">
                ${
                  revenueStatus === "under"
                    ? `Revenue shortfall of $${Math.abs(
                        variance.revenue
                      ).toLocaleString()} requires investigation`
                    : "Revenue performance exceeding expectations"
                }
              </div>
            </div>
          </div>
        </div>
      `
          : ""
      }
    </div>
  `;
      }

      // ====== TRIAL BALANCE DATA LOADING ======

      async function loadTrialBalanceData() {
        if (activeCompanyFilters.length === 0) {
          showNoCompaniesSelected();
          return;
        }

        try {
          if (activeCompanyFilters.length === 1) {
            // Single company - show detailed individual view
            await loadSingleCompanyTrialBalance();
          } else {
            // Multiple companies - show consolidated view
            await loadConsolidatedTrialBalance();
          }
        } catch (error) {
          showErrorState(error);
        }
      }

      async function loadSingleCompanyTrialBalance() {
        const tenantId = activeCompanyFilters[0];
        const connectedCompany = connectedCompanies.find(
          (c) => c.tenantId === tenantId
        );

        if (!connectedCompany) return;

        const orgName = getOrganizationName(connectedCompany.tenantName);
        const response = await fetchWithErrorHandling("/api/trial-balance", {
          organizationName: orgName,
        });

        if (response && response.ok) {
          const data = await response.json();
          renderSingleCompanyTrialBalance(data, connectedCompany);
        } else {
          showErrorState(
            new Error(
              `Failed to load trial balance for ${connectedCompany.tenantName}`
            )
          );
        }
      }

      function renderSingleCompanyTrialBalance(data, company) {
        const dashboardElement = document.getElementById("dashboardData");
        const companyName = company.tenantName.replace("Rirratjingu ", "");
        const tb = data.trialBalance;
        const isBalanced = data.balanceCheck.debitsEqualCredits;

        dashboardElement.innerHTML = `
    <!-- SINGLE COMPANY TRIAL BALANCE -->
    <div class="dashboard-card">
      <h3>Trial Balance - ${companyName}</h3>
      <div style="margin-bottom: 15px;">
        <strong>Status:</strong>
        <span style="color: ${isBalanced ? "#27ae60" : "#e74c3c"};">
          ${isBalanced ? "✅ Balanced" : "⚠️ Out of Balance"}
        </span>
        <span style="margin-left: 20px; font-size: 14px; color: #666;">
          Total Accounts: ${
            tb.assets.length + tb.liabilities.length + tb.equity.length
          } |
          ${
            isBalanced
              ? "Perfect Balance"
              : `Difference: $${Math.abs(
                  data.balanceCheck.difference || 0
                ).toLocaleString()}`
          }
        </span>
      </div>

      <!-- DETAILED TRIAL BALANCE TABLE -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        
        <!-- ASSETS -->
        <div>
          <h4 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 8px;">
            Assets (${tb.assets.length} accounts)
          </h4>
          <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            ${tb.assets
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;">
                <div>
                  <div style="font-weight: 500; font-size: 13px;">${
                    account.name
                  }</div>
                  ${
                    account.code
                      ? `<div style="font-size: 11px; color: #666;">${account.code}</div>`
                      : ""
                  }
                </div>
                <div style="font-weight: 600; text-align: right;">
                  $${account.balance.toLocaleString()}
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="border-top: 3px solid #27ae60; padding: 12px; font-weight: bold; color: #27ae60; background: #f8fff8;">
            Total Assets: $${tb.totals.totalAssets.toLocaleString()}
          </div>
        </div>

        <!-- LIABILITIES -->
        <div>
          <h4 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 8px;">
            Liabilities (${tb.liabilities.length} accounts)
          </h4>
          <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            ${tb.liabilities
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;">
                <div>
                  <div style="font-weight: 500; font-size: 13px;">${
                    account.name
                  }</div>
                  ${
                    account.code
                      ? `<div style="font-size: 11px; color: #666;">${account.code}</div>`
                      : ""
                  }
                </div>
                <div style="font-weight: 600; text-align: right;">
                  $${Math.abs(account.balance).toLocaleString()}
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="border-top: 3px solid #e74c3c; padding: 12px; font-weight: bold; color: #e74c3c; background: #fff8f8;">
            Total Liabilities: $${Math.abs(
              tb.totals.totalLiabilities
            ).toLocaleString()}
          </div>
        </div>

        <!-- EQUITY -->
        <div>
          <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
            Equity (${tb.equity.length} accounts)
          </h4>
          <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            ${tb.equity
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;">
                <div>
                  <div style="font-weight: 500; font-size: 13px;">${
                    account.name
                  }</div>
                  ${
                    account.code
                      ? `<div style="font-size: 11px; color: #666;">${account.code}</div>`
                      : ""
                  }
                </div>
                <div style="font-weight: 600; text-align: right;">
                  $${account.balance.toLocaleString()}
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="border-top: 3px solid #3498db; padding: 12px; font-weight: bold; color: #3498db; background: #f8fffe;">
            Total Equity: $${tb.totals.totalEquity.toLocaleString()}
          </div>
        </div>
      </div>

      ${
        !isBalanced
          ? `
        <!-- BALANCE ISSUE ALERT -->
        <div style="margin-top: 20px; padding: 15px; background: #fff8f8; border: 1px solid #e74c3c; border-radius: 6px;">
          <h4 style="color: #e74c3c; margin-bottom: 8px;">⚠️ Balance Issue Detected</h4>
          <div>Difference: $${Math.abs(
            data.balanceCheck.difference || 0
          ).toLocaleString()}</div>
          <div style="font-size: 13px; margin-top: 8px; color: #666;">
            Recommended Action: Review journal entries and account reconciliations for this company.
          </div>
        </div>
      `
          : ""
      }
    </div>
  `;
      }

      // ====== CONSOLIDATED TRIAL BALANCE (MULTIPLE COMPANIES) ======
      async function loadConsolidatedTrialBalance() {
        const consolidatedData = {
          companies: [],
          consolidated: {
            totals: { totalAssets: 0, totalLiabilities: 0, totalEquity: 0 },
            balanceCheck: { debitsEqualCredits: true },
          },
          summary: {
            totalCompanies: 0,
            totalAccounts: 0,
            balancedCompanies: 0,
          },
        };

        // Load data from each selected company
        for (const tenantId of activeCompanyFilters) {
          const connectedCompany = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          if (!connectedCompany) continue;

          const orgName = getOrganizationName(connectedCompany.tenantName);
          const response = await fetchWithErrorHandling("/api/trial-balance", {
            organizationName: orgName,
          });

          if (response && response.ok) {
            const data = await response.json();
            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );

            consolidatedData.companies.push({
              companyName: companyName,
              sections: {
                assets: { accounts: data.trialBalance.assets || [] },
                liabilities: { accounts: data.trialBalance.liabilities || [] },
                equity: { accounts: data.trialBalance.equity || [] },
              },
              balanceCheck: data.balanceCheck || {
                debitsEqualCredits: true,
                difference: 0,
              },
            });

            // Update consolidated totals
            const totals = data.trialBalance.totals || {};
            consolidatedData.consolidated.totals.totalAssets +=
              totals.totalAssets || 0;
            consolidatedData.consolidated.totals.totalLiabilities +=
              totals.totalLiabilities || 0;
            consolidatedData.consolidated.totals.totalEquity +=
              totals.totalEquity || 0;

            // Update summary
            consolidatedData.summary.totalCompanies++;
            consolidatedData.summary.totalAccounts +=
              (data.trialBalance.assets?.length || 0) +
              (data.trialBalance.liabilities?.length || 0) +
              (data.trialBalance.equity?.length || 0);

            if (data.balanceCheck?.debitsEqualCredits !== false) {
              consolidatedData.summary.balancedCompanies++;
            } else {
              consolidatedData.consolidated.balanceCheck.debitsEqualCredits = false;
            }
          }
        }

        renderConsolidatedTrialBalance(consolidatedData);
      }

      // ====== UPDATED CONSOLIDATED TRIAL BALANCE WITH EXPANDABLE SECTIONS ======

      function renderConsolidatedTrialBalance(data) {
        const dashboardElement = document.getElementById("dashboardData");

        if (!data || !data.companies || data.companies.length === 0) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Trial Balance Data Available</h3>
        <p>Unable to load trial balance information for the selected companies.</p>
      </div>
    `;
          return;
        }

        // Build consolidated accounts by combining all companies
        const consolidatedAccounts = {
          assets: {},
          liabilities: {},
          equity: {},
        };

        // Aggregate accounts across all companies
        data.companies.forEach((company) => {
          ["assets", "liabilities", "equity"].forEach((category) => {
            if (
              company.sections &&
              company.sections[category] &&
              company.sections[category].accounts
            ) {
              company.sections[category].accounts.forEach((account) => {
                if (!consolidatedAccounts[category][account.name]) {
                  consolidatedAccounts[category][account.name] = 0;
                }
                consolidatedAccounts[category][account.name] +=
                  account.balance || 0;
              });
            }
          });
        });

        // Convert to arrays and sort
        const assetAccounts = Object.entries(consolidatedAccounts.assets)
          .map(([name, balance]) => ({ name, balance }))
          .sort((a, b) => b.balance - a.balance);

        const liabilityAccounts = Object.entries(
          consolidatedAccounts.liabilities
        )
          .map(([name, balance]) => ({ name, balance }))
          .sort((a, b) => Math.abs(b.balance) - Math.abs(a.balance));

        const equityAccounts = Object.entries(consolidatedAccounts.equity)
          .map(([name, balance]) => ({ name, balance }))
          .sort((a, b) => b.balance - a.balance);

        // Safe access to totals with fallbacks
        const totals = data.consolidated?.totals || {
          totalAssets: 0,
          totalLiabilities: 0,
          totalEquity: 0,
        };
        const balanceCheck = data.consolidated?.balanceCheck || {
          debitsEqualCredits: true,
        };
        const summary = data.summary || {
          totalCompanies: 0,
          balancedCompanies: 0,
        };
        const isBalanced = balanceCheck.debitsEqualCredits;

        // Helper function to render account list with expand/collapse
        const renderAccountList = (accounts, category, showLimit = 10) => {
          const categoryColors = {
            assets: { main: "#27ae60", bg: "#f8fff8", border: "#27ae60" },
            liabilities: { main: "#e74c3c", bg: "#fff8f8", border: "#e74c3c" },
            equity: { main: "#3498db", bg: "#f8fffe", border: "#3498db" },
          };

          const colors = categoryColors[category];
          const displayAccounts = accounts.slice(0, showLimit);
          const hiddenAccounts = accounts.slice(showLimit);
          const expandedId = `expanded-${category}`;
          const buttonId = `expand-btn-${category}`;

          return `
      <div>
        <h4 style="color: ${colors.main}; border-bottom: 2px solid ${
            colors.main
          }; padding-bottom: 8px; margin-bottom: 15px;">
          ${category.charAt(0).toUpperCase() + category.slice(1)} (${
            accounts.length
          } accounts)
        </h4>
        
        <div style="border: 1px solid #e0e0e0; border-radius: 4px; max-height: 50vh; overflow-y: auto;">
          ${
            displayAccounts.length === 0
              ? `
            <div style="text-align: center; padding: 30px; color: #666;">
              No ${category} accounts found
            </div>
          `
              : `
            <!-- ALWAYS VISIBLE ACCOUNTS -->
            ${displayAccounts
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px;">
                <span style="flex: 1; margin-right: 10px;">${
                  account.name
                }</span>
                <span style="font-weight: 600; min-width: 100px; text-align: right;">
                  $${
                    category === "liabilities"
                      ? Math.abs(account.balance).toLocaleString()
                      : account.balance.toLocaleString()
                  }
                </span>
              </div>
            `
              )
              .join("")}
            
            ${
              hiddenAccounts.length > 0
                ? `
              <!-- EXPANDABLE SECTION -->
              <div id="${expandedId}" style="display: none;">
                ${hiddenAccounts
                  .map(
                    (account) => `
                  <div style="display: flex; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px; background: ${
                    colors.bg
                  };">
                    <span style="flex: 1; margin-right: 10px;">${
                      account.name
                    }</span>
                    <span style="font-weight: 600; min-width: 100px; text-align: right;">
                      $${
                        category === "liabilities"
                          ? Math.abs(account.balance).toLocaleString()
                          : account.balance.toLocaleString()
                      }
                    </span>
                  </div>
                `
                  )
                  .join("")}
              </div>
              
              <!-- EXPAND/COLLAPSE BUTTON -->
              <div style="text-align: center; padding: 10px; background: #f8f9fa; border-top: 1px solid #e0e0e0;">
                <button 
                  id="${buttonId}"
                  onclick="toggleAccountExpansion('${category}')" 
                  style="background: ${
                    colors.main
                  }; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;"
                  onmouseover="this.style.opacity='0.8'" 
                  onmouseout="this.style.opacity='1'">
                  <span id="${buttonId}-text">Show All ${
                    hiddenAccounts.length
                  } More</span>
                  <span id="${buttonId}-icon" style="margin-left: 5px;">▼</span>
                </button>
              </div>
            `
                : ""
            }
          `
          }
        </div>
        
        <div style="border-top: 3px solid ${
          colors.main
        }; padding: 12px; font-weight: bold; color: ${
            colors.main
          }; background: ${colors.bg};">
          Total ${category.charAt(0).toUpperCase() + category.slice(1)}: 
          $${
            category === "liabilities"
              ? Math.abs(totals.totalLiabilities || 0).toLocaleString()
              : (
                  totals[
                    `total${
                      category.charAt(0).toUpperCase() + category.slice(1)
                    }`
                  ] || 0
                ).toLocaleString()
          }
        </div>
      </div>
    `;
        };

        dashboardElement.innerHTML = `
    <!-- CONSOLIDATED TRIAL BALANCE HEADER -->
    <div class="dashboard-card" style="margin-bottom: 20px;">
      <h3>Consolidated Trial Balance - All Selected Companies</h3>
      <div style="margin-bottom: 15px;">
        <strong>Status:</strong>
        <span style="color: ${isBalanced ? "#27ae60" : "#e74c3c"};">
          ${isBalanced ? "✅ Balanced" : "⚠️ Out of Balance"}
        </span>
        <span style="margin-left: 20px; font-size: 14px; color: #666;">
          Companies: ${summary.totalCompanies} | 
          Balanced: ${summary.balancedCompanies}/${summary.totalCompanies} |
          Total Accounts: ${
            assetAccounts.length +
            liabilityAccounts.length +
            equityAccounts.length
          }
        </span>
      </div>

      <!-- CONSOLIDATED TRIAL BALANCE TABLE WITH EXPANDABLE SECTIONS -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        ${renderAccountList(assetAccounts, "assets")}
        ${renderAccountList(liabilityAccounts, "liabilities")}
        ${renderAccountList(equityAccounts, "equity")}
      </div>

      <!-- BALANCE CHECK SUMMARY -->
      <div style="margin-top: 20px; padding: 15px; background: ${
        isBalanced ? "#f8fff8" : "#fff8f8"
      }; border-radius: 6px; border: 1px solid ${
          isBalanced ? "#27ae60" : "#e74c3c"
        };">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>Balance Check:</strong>
            <span style="color: ${
              isBalanced ? "#27ae60" : "#e74c3c"
            }; margin-left: 10px;">
              ${
                isBalanced
                  ? "All companies balanced ✅"
                  : `${summary.balancedCompanies}/${summary.totalCompanies} companies balanced ⚠️`
              }
            </span>
          </div>
          <div style="font-size: 14px; color: #666;">
            ${
              isBalanced
                ? "Trial balance is in perfect balance across all selected companies."
                : "Some companies have trial balance discrepancies that need attention."
            }
          </div>
        </div>
      </div>
    </div>

    <!-- INDIVIDUAL COMPANY STATUS -->
    <div class="dashboard-card" style="max-height: 60vh; overflow-y: scroll; border: 1px solid #e0e0e0;">
      <h3 style="position: sticky; top: 0; background: white; padding: 15px; margin: -20px -20px 10px -20px; border-bottom: 1px solid #e0e0e0;">
        Individual Company Trial Balance Status
      </h3>
      <div style="padding: 0 20px 20px 20px;">
        ${data.companies
          .map((company) => {
            const isCompanyBalanced =
              company.balanceCheck?.debitsEqualCredits !== false;
            const difference = company.balanceCheck?.difference || 0;

            return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid ${
              isCompanyBalanced ? "#27ae60" : "#e74c3c"
            }; background: ${isCompanyBalanced ? "#f8fff8" : "#fff8f8"};">
              <div>
                <strong style="font-size: 16px;">${company.companyName}</strong>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                  ${
                    (company.sections.assets?.accounts?.length || 0) +
                    (company.sections.liabilities?.accounts?.length || 0) +
                    (company.sections.equity?.accounts?.length || 0)
                  } accounts
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: bold; color: ${
                  isCompanyBalanced ? "#27ae60" : "#e74c3c"
                };">
                  ${isCompanyBalanced ? "✅ Balanced" : "⚠️ Out of Balance"}
                </div>
                ${
                  !isCompanyBalanced && Math.abs(difference) > 0
                    ? `
                  <div style="font-size: 11px; color: #e74c3c; margin-top: 2px;">
                    Difference: $${Math.abs(difference).toLocaleString()}
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          `;
          })
          .join("")}
      </div>

      ${
        summary.balancedCompanies < summary.totalCompanies
          ? `
        <div style="position: sticky; bottom: 0; background: white; margin: 0 -20px -20px -20px; padding: 15px; border-top: 1px solid #e0e0e0;">
          <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
            <strong>⚠️ Action Required:</strong> 
            ${summary.totalCompanies - summary.balancedCompanies} ${
              summary.totalCompanies - summary.balancedCompanies === 1
                ? "company has"
                : "companies have"
            } trial balance discrepancies. 
            Review journal entries and account reconciliations for the affected ${
              summary.totalCompanies - summary.balancedCompanies === 1
                ? "company"
                : "companies"
            }.
          </div>
        </div>
      `
          : ""
      }
    </div>
  `;
      }

      // ====== EXPAND/COLLAPSE FUNCTIONALITY ======
      function toggleAccountExpansion(category) {
        const expandedSection = document.getElementById(`expanded-${category}`);
        const button = document.getElementById(`expand-btn-${category}`);
        const buttonText = document.getElementById(
          `expand-btn-${category}-text`
        );
        const buttonIcon = document.getElementById(
          `expand-btn-${category}-icon`
        );

        if (
          expandedSection.style.display === "none" ||
          expandedSection.style.display === ""
        ) {
          // EXPAND
          expandedSection.style.display = "block";
          buttonText.textContent = "Show Less";
          buttonIcon.textContent = "▲";
          button.style.background = "#95a5a6";
        } else {
          // COLLAPSE
          expandedSection.style.display = "none";
          const hiddenCount = expandedSection.children.length;
          buttonText.textContent = `Show All ${hiddenCount} More`;
          buttonIcon.textContent = "▼";

          // Reset color based on category
          const categoryColors = {
            assets: "#27ae60",
            liabilities: "#e74c3c",
            equity: "#3498db",
          };
          button.style.background = categoryColors[category];
        }
      }

      // ====== UTILITY FUNCTIONS ======

      async function fetchWithErrorHandling(url, body = null) {
        try {
          const options = {
            method: body ? "POST" : "GET",
            headers: body ? { "Content-Type": "application/json" } : {},
            body: body ? JSON.stringify(body) : null,
          };
          return await fetch(url, options);
        } catch (error) {
          console.error(`Fetch error for ${url}:`, error);
          return null;
        }
      }

      function showNoCompaniesSelected() {
        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view financial data.</p>
      </div>
    `;
      }

      // ====== SCROLL MODE TOGGLE ======
      let isFullScrollMode = false;

      function toggleScrollMode() {
        isFullScrollMode = !isFullScrollMode;
        const toggleBtn = document.getElementById("scrollModeToggle");
        const companyPerformanceContainer = document.querySelector(
          '.dashboard-card[style*="grid-column: 1 / -1"] > div[style*="max-height"]'
        );

        if (isFullScrollMode) {
          // Enable full-page scrolling
          if (companyPerformanceContainer) {
            companyPerformanceContainer.style.maxHeight = "none";
            companyPerformanceContainer.style.overflowY = "visible";
          }
          toggleBtn.innerHTML = "📜 Disable Full Scroll";
          toggleBtn.style.background = "#27ae60";
          toggleBtn.title = "Switch back to contained scrolling";

          // Store preference
          localStorage.setItem("racScrollMode", "full");
        } else {
          // Revert to contained scrolling
          if (companyPerformanceContainer) {
            companyPerformanceContainer.style.maxHeight = "500px";
            companyPerformanceContainer.style.overflowY = "auto";
          }
          toggleBtn.innerHTML = "📜 Enable Full Scroll";
          toggleBtn.style.background = "#3498db";
          toggleBtn.title = "Toggle full-page scrolling";

          // Store preference
          localStorage.setItem("racScrollMode", "contained");
        }
      }

      // Apply saved scroll preference on page load
      function applySavedScrollMode() {
        const savedMode = localStorage.getItem("racScrollMode");
        if (savedMode === "full") {
          // Wait for dashboard to render, then enable full scroll
          setTimeout(() => {
            toggleScrollMode();
          }, 500);
        }
      }

      // ====== PLACEHOLDER FUNCTIONS FOR OTHER VIEWS ======
      // These maintain the existing structure while being organized

      // ====== CASH FLOW DATA LOADING - LOGICAL STRUCTURE ======

      async function loadCashFlowData() {
        if (activeCompanyFilters.length === 0) {
          showNoCompaniesSelected();
          return;
        }

        try {
          if (activeCompanyFilters.length === 1) {
            // Single company - show detailed cash flow view
            await loadSingleCompanyCashFlow();
          } else {
            // Multiple companies - show consolidated cash position
            await loadConsolidatedCashFlow();
          }
        } catch (error) {
          showErrorState(error);
        }
      }

      // ====== SINGLE COMPANY CASH FLOW ======
      async function loadSingleCompanyCashFlow() {
        const tenantId = activeCompanyFilters[0];
        const connectedCompany = connectedCompanies.find(
          (c) => c.tenantId === tenantId
        );

        if (!connectedCompany) return;

        const orgName = getOrganizationName(connectedCompany.tenantName);
        const response = await fetchWithErrorHandling("/api/cash-position", {
          organizationName: orgName,
        });

        if (response && response.ok) {
          const data = await response.json();
          renderSingleCompanyCashFlow(data, connectedCompany);
        } else {
          showErrorState(
            new Error(
              `Failed to load cash position for ${connectedCompany.tenantName}`
            )
          );
        }
      }

      function renderSingleCompanyCashFlow(data, company) {
        const dashboardElement = document.getElementById("dashboardData");
        const companyName = company.tenantName.replace("Rirratjingu ", "");
        const bankAccounts = data.bankAccounts || [];
        const totalCash = data.totalCash || 0;

        // Sort bank accounts by balance (highest first)
        const sortedAccounts = bankAccounts.sort(
          (a, b) => b.balance - a.balance
        );

        // Categorize accounts
        const positiveAccounts = sortedAccounts.filter(
          (acc) => acc.balance > 0
        );
        const zeroAccounts = sortedAccounts.filter((acc) => acc.balance === 0);
        const negativeAccounts = sortedAccounts.filter(
          (acc) => acc.balance < 0
        );

        dashboardElement.innerHTML = `
    <!-- SINGLE COMPANY CASH FLOW -->
    <div class="dashboard-card">
      <h3>Cash Position - ${companyName}</h3>
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>Total Cash Position:</strong>
            <span style="font-size: 24px; font-weight: bold; margin-left: 15px; color: ${
              totalCash >= 0 ? "#27ae60" : "#e74c3c"
            };">
              $${totalCash.toLocaleString()}
            </span>
          </div>
          <div style="font-size: 14px; color: #666;">
            ${bankAccounts.length} Bank Account${
          bankAccounts.length !== 1 ? "s" : ""
        } |
            ${positiveAccounts.length} Positive | 
            ${zeroAccounts.length} Zero | 
            ${negativeAccounts.length} Negative
          </div>
        </div>
      </div>

      ${
        bankAccounts.length === 0
          ? `
        <!-- NO BANK ACCOUNTS -->
        <div style="text-align: center; padding: 40px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
          <h4>No Bank Accounts Found</h4>
          <p>No bank account data available for this company. This could indicate:</p>
          <ul style="text-align: left; margin: 15px 0;">
            <li>Bank feeds are not connected in Xero</li>
            <li>No bank accounts have been set up</li>
            <li>Data synchronization issues</li>
          </ul>
          <p style="font-size: 13px; color: #856404;">
            <strong>Action:</strong> Check Xero bank account setup and connectivity.
          </p>
        </div>
      `
          : `
        <!-- DETAILED BANK ACCOUNTS -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
          
          ${
            positiveAccounts.length > 0
              ? `
            <!-- POSITIVE BALANCE ACCOUNTS -->
            <div>
              <h4 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 8px; margin-bottom: 15px;">
                💰 Positive Balance Accounts (${positiveAccounts.length})
              </h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                ${positiveAccounts
                  .map(
                    (account) => `
                  <div style="border: 1px solid #27ae60; border-radius: 6px; padding: 15px; background: #f8fff8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <div>
                        <div style="font-weight: 600; font-size: 14px;">${
                          account.name
                        }</div>
                        ${
                          account.code
                            ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">Account: ${account.code}</div>`
                            : ""
                        }
                      </div>
                      <div style="font-size: 18px; font-weight: bold; color: #27ae60;">
                        $${account.balance.toLocaleString()}
                      </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                      ${((account.balance / totalCash) * 100).toFixed(
                        1
                      )}% of total cash
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `
              : ""
          }

          ${
            zeroAccounts.length > 0
              ? `
            <!-- ZERO BALANCE ACCOUNTS -->
            <div>
              <h4 style="color: #f39c12; border-bottom: 2px solid #f39c12; padding-bottom: 8px; margin-bottom: 15px;">
                ⚠️ Zero Balance Accounts (${zeroAccounts.length})
              </h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
                ${zeroAccounts
                  .map(
                    (account) => `
                  <div style="border: 1px solid #f39c12; border-radius: 6px; padding: 12px; background: #fffdf5;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-weight: 500; font-size: 13px;">${
                          account.name
                        }</div>
                        ${
                          account.code
                            ? `<div style="font-size: 10px; color: #666;">${account.code}</div>`
                            : ""
                        }
                      </div>
                      <div style="font-weight: bold; color: #f39c12;">$0.00</div>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `
              : ""
          }

          ${
            negativeAccounts.length > 0
              ? `
            <!-- NEGATIVE BALANCE ACCOUNTS -->
            <div>
              <h4 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 8px; margin-bottom: 15px;">
                🚨 Overdrawn Accounts (${negativeAccounts.length})
              </h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                ${negativeAccounts
                  .map(
                    (account) => `
                  <div style="border: 1px solid #e74c3c; border-radius: 6px; padding: 15px; background: #fff8f8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <div>
                        <div style="font-weight: 600; font-size: 14px;">${
                          account.name
                        }</div>
                        ${
                          account.code
                            ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">Account: ${account.code}</div>`
                            : ""
                        }
                      </div>
                      <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">
                        $${account.balance.toLocaleString()}
                      </div>
                    </div>
                    <div style="font-size: 12px; color: #e74c3c; font-weight: 500;">
                      ⚠️ OVERDRAWN - Immediate attention required
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `
              : ""
          }
        </div>

        <!-- CASH FLOW INSIGHTS -->
        <div style="margin-top: 25px; padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
          <h4 style="color: #0c5460; margin-bottom: 10px;">💡 Cash Flow Insights</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 13px;">
            <div>
              <strong>Liquidity Status:</strong>
              <div style="margin-top: 5px;">
                ${
                  totalCash > 100000
                    ? "Strong cash position - excellent liquidity"
                    : totalCash > 25000
                    ? "Good cash position - adequate liquidity"
                    : totalCash > 0
                    ? "Low cash position - monitor closely"
                    : "Critical - negative cash position"
                }
              </div>
            </div>
            <div>
              <strong>Account Distribution:</strong>
              <div style="margin-top: 5px;">
                ${
                  positiveAccounts.length > 0 &&
                  positiveAccounts.length === bankAccounts.length
                    ? "All accounts positive - healthy"
                    : negativeAccounts.length > 0
                    ? "Some overdrawn accounts - review needed"
                    : "Mixed account status - monitor carefully"
                }
              </div>
            </div>
            <div>
              <strong>Largest Account:</strong>
              <div style="margin-top: 5px;">
                ${
                  sortedAccounts.length > 0
                    ? `${
                        sortedAccounts[0].name
                      }: $${sortedAccounts[0].balance.toLocaleString()}`
                    : "No account data"
                }
              </div>
            </div>
          </div>
        </div>
      `
      }
    </div>
  `;
      }

      // ====== CONSOLIDATED CASH FLOW (MULTIPLE COMPANIES) ======
      async function loadConsolidatedCashFlow() {
        const consolidatedData = {
          companies: [],
          totalCash: 0,
          totalAccounts: 0,
          bankAccounts: {},
          summary: {
            positiveCompanies: 0,
            negativeCompanies: 0,
            zeroCompanies: 0,
            overdrawnAccounts: 0,
          },
        };

        // Load data from each selected company
        for (const tenantId of activeCompanyFilters) {
          const connectedCompany = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          if (!connectedCompany) continue;

          const orgName = getOrganizationName(connectedCompany.tenantName);
          const response = await fetchWithErrorHandling("/api/cash-position", {
            organizationName: orgName,
          });

          if (response && response.ok) {
            const data = await response.json();
            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );

            // Track company cash status
            consolidatedData.companies.push({
              name: companyName,
              totalCash: data.totalCash || 0,
              accountCount: (data.bankAccounts || []).length,
              bankAccounts: data.bankAccounts || [],
              status:
                data.totalCash > 0
                  ? "positive"
                  : data.totalCash === 0
                  ? "zero"
                  : "negative",
            });

            // Aggregate totals
            consolidatedData.totalCash += data.totalCash || 0;
            consolidatedData.totalAccounts += (data.bankAccounts || []).length;

            // Update summary counts
            if (data.totalCash > 0)
              consolidatedData.summary.positiveCompanies++;
            else if (data.totalCash === 0)
              consolidatedData.summary.zeroCompanies++;
            else consolidatedData.summary.negativeCompanies++;

            // Aggregate bank accounts by name and track overdrafts
            if (data.bankAccounts) {
              data.bankAccounts.forEach((account) => {
                const accountKey = account.name;
                if (!consolidatedData.bankAccounts[accountKey]) {
                  consolidatedData.bankAccounts[accountKey] = {
                    name: account.name,
                    totalBalance: 0,
                    companies: [],
                    overdrawnCount: 0,
                  };
                }
                consolidatedData.bankAccounts[accountKey].totalBalance +=
                  account.balance;
                consolidatedData.bankAccounts[accountKey].companies.push({
                  company: companyName,
                  balance: account.balance,
                  code: account.code,
                });

                if (account.balance < 0) {
                  consolidatedData.bankAccounts[accountKey].overdrawnCount++;
                  consolidatedData.summary.overdrawnAccounts++;
                }
              });
            }
          }
        }

        renderConsolidatedCashFlow(consolidatedData);
      }

      function renderConsolidatedCashFlow(data) {
        const dashboardElement = document.getElementById("dashboardData");

        // Convert consolidated bank accounts to sorted array
        const consolidatedBankAccounts = Object.values(data.bankAccounts).sort(
          (a, b) => b.totalBalance - a.totalBalance
        );

        const healthyCompanies = data.summary.positiveCompanies;
        const problematicCompanies =
          data.summary.negativeCompanies + data.summary.zeroCompanies;

        dashboardElement.innerHTML = `
    <!-- CONSOLIDATED CASH FLOW HEADER -->
    <div class="dashboard-card">
      <h3>Consolidated Cash Position - ${data.companies.length} Companies</h3>
      <div style="margin-bottom: 20px;">
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; margin: 15px 0; color: ${
            data.totalCash >= 0 ? "#27ae60" : "#e74c3c"
          };">
            $${data.totalCash.toLocaleString()}
          </div>
          <div style="font-size: 16px; color: #666;">Total Consolidated Cash Position</div>
        </div>
      </div>

      <!-- CASH SUMMARY CARDS -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
        <div style="text-align: center; padding: 15px; background: #f8fff8; border-radius: 6px; border: 1px solid #27ae60;">
          <div style="font-size: 20px; font-weight: bold; color: #27ae60;">
            ${data.summary.positiveCompanies}
          </div>
          <div style="font-size: 13px; color: #666;">Positive Cash</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fffdf5; border-radius: 6px; border: 1px solid #f39c12;">
          <div style="font-size: 20px; font-weight: bold; color: #f39c12;">
            ${data.summary.zeroCompanies}
          </div>
          <div style="font-size: 13px; color: #666;">Zero Balance</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fff8f8; border-radius: 6px; border: 1px solid #e74c3c;">
          <div style="font-size: 20px; font-weight: bold; color: #e74c3c;">
            ${data.summary.negativeCompanies}
          </div>
          <div style="font-size: 13px; color: #666;">Negative Cash</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #f8fffe; border-radius: 6px; border: 1px solid #3498db;">
          <div style="font-size: 20px; font-weight: bold; color: #3498db;">
            ${data.totalAccounts}
          </div>
          <div style="font-size: 13px; color: #666;">Total Accounts</div>
        </div>
      </div>

      ${
        consolidatedBankAccounts.length > 0
          ? `
        <!-- CONSOLIDATED BANK ACCOUNTS -->
        <div>
          <h4>Consolidated Bank Account Balances</h4>
          <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px;">
            ${consolidatedBankAccounts
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px;">
                    ${account.name}
                    ${
                      account.overdrawnCount > 0
                        ? `<span style="color: #e74c3c; font-size: 11px; margin-left: 8px;">⚠️ ${account.overdrawnCount} overdrawn</span>`
                        : ""
                    }
                  </div>
                  <div style="font-size: 12px; color: #666;">
                    ${account.companies
                      .map(
                        (comp) =>
                          `${comp.company}: $${comp.balance.toLocaleString()}`
                      )
                      .join(" | ")}
                  </div>
                </div>
                <div style="font-weight: 600; font-size: 16px; text-align: right; color: ${
                  account.totalBalance >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${account.totalBalance.toLocaleString()}
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `
          : `
        <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 6px;">
          <h4>No Bank Account Data</h4>
          <p>No consolidated bank account information available across selected companies.</p>
        </div>
      `
      }
    </div>

    <!-- INDIVIDUAL COMPANY CASH STATUS -->
    <div class="dashboard-card">
      <h3>Individual Company Cash Status</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
        ${data.companies
          .map(
            (company) => `
          <div style="border: 1px solid ${
            company.status === "positive"
              ? "#27ae60"
              : company.status === "zero"
              ? "#f39c12"
              : "#e74c3c"
          }; border-radius: 6px; padding: 15px; background: ${
              company.status === "positive"
                ? "#f8fff8"
                : company.status === "zero"
                ? "#fffdf5"
                : "#fff8f8"
            };">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="font-size: 14px;">${company.name}</strong>
              <div style="font-size: 16px; font-weight: bold; color: ${
                company.status === "positive"
                  ? "#27ae60"
                  : company.status === "zero"
                  ? "#f39c12"
                  : "#e74c3c"
              };">
                $${company.totalCash.toLocaleString()}
              </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
              ${company.accountCount} bank account${
              company.accountCount !== 1 ? "s" : ""
            }
            </div>
            <div style="font-size: 11px;">
              Status: <span style="color: ${
                company.status === "positive"
                  ? "#27ae60"
                  : company.status === "zero"
                  ? "#f39c12"
                  : "#e74c3c"
              }; font-weight: 500;">
                ${
                  company.status === "positive"
                    ? "✅ Healthy"
                    : company.status === "zero"
                    ? "⚠️ Zero Balance"
                    : "🚨 Negative"
                }
              </span>
            </div>
          </div>
        `
          )
          .join("")}
      </div>

      <!-- CONSOLIDATED INSIGHTS -->
      <div style="margin-top: 25px; padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
        <h4 style="color: #0c5460; margin-bottom: 10px;">🏢 Consolidated Cash Flow Insights</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 13px;">
          <div>
            <strong>Overall Health:</strong>
            <div style="margin-top: 5px;">
              ${
                healthyCompanies === data.companies.length
                  ? "Excellent - All companies positive"
                  : healthyCompanies > problematicCompanies
                  ? "Good - Majority of companies healthy"
                  : "Concerning - Multiple companies with cash issues"
              }
            </div>
          </div>
          <div>
            <strong>Risk Assessment:</strong>
            <div style="margin-top: 5px;">
              ${
                data.summary.overdrawnAccounts === 0
                  ? "Low risk - No overdrawn accounts"
                  : data.summary.overdrawnAccounts < 3
                  ? "Medium risk - Some overdrawn accounts"
                  : "High risk - Multiple overdrawn accounts"
              }
            </div>
          </div>
          <div>
            <strong>Cash Concentration:</strong>
            <div style="margin-top: 5px;">
              ${
                data.companies.length > 0
                  ? `Average per company: $${Math.round(
                      data.totalCash / data.companies.length
                    ).toLocaleString()}`
                  : "No data available"
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
      }

      // ====== PROFIT & LOSS DATA LOADING - LOGICAL STRUCTURE ======

      async function loadProfitLossData() {
        if (activeCompanyFilters.length === 0) {
          showNoCompaniesSelected();
          return;
        }

        try {
          if (activeCompanyFilters.length === 1) {
            // Single company - show detailed P&L breakdown
            await loadSingleCompanyProfitLoss();
          } else {
            // Multiple companies - show consolidated P&L summary
            await loadConsolidatedProfitLoss();
          }
        } catch (error) {
          showErrorState(error);
        }
      }

      // ====== SINGLE COMPANY PROFIT & LOSS ======
      async function loadSingleCompanyProfitLoss() {
        const tenantId = activeCompanyFilters[0];
        const connectedCompany = connectedCompanies.find(
          (c) => c.tenantId === tenantId
        );

        if (!connectedCompany) return;

        const orgName = getOrganizationName(connectedCompany.tenantName);
        const response = await fetchWithErrorHandling(
          "/api/profit-loss-summary",
          {
            organizationName: orgName,
          }
        );

        if (response && response.ok) {
          const data = await response.json();
          renderSingleCompanyProfitLoss(data, connectedCompany);
        } else {
          showErrorState(
            new Error(`Failed to load P&L for ${connectedCompany.tenantName}`)
          );
        }
      }

      function renderSingleCompanyProfitLoss(data, company) {
        const dashboardElement = document.getElementById("dashboardData");
        const companyName = company.tenantName.replace("Rirratjingu ", "");
        const summary = data.summary || {};

        const totalRevenue = summary.totalRevenue || 0;
        const totalExpenses = summary.totalExpenses || 0;
        const netProfit = summary.netProfit || 0;
        const profitMargin =
          totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

        const revenueAccounts = (summary.revenueAccounts || []).sort(
          (a, b) => b.amount - a.amount
        );
        const expenseAccounts = (summary.expenseAccounts || []).sort(
          (a, b) => b.amount - a.amount
        );

        // Categorize expenses for insights
        const largeExpenses = expenseAccounts.filter(
          (acc) => acc.amount > totalExpenses * 0.1
        );
        const mediumExpenses = expenseAccounts.filter(
          (acc) =>
            acc.amount <= totalExpenses * 0.1 &&
            acc.amount > totalExpenses * 0.02
        );
        const smallExpenses = expenseAccounts.filter(
          (acc) => acc.amount <= totalExpenses * 0.02
        );

        dashboardElement.innerHTML = `
    <!-- SINGLE COMPANY P&L HEADER -->
    <div class="dashboard-card">
      <h3>Profit & Loss Statement - ${companyName}</h3>
      <div style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
          
          <!-- REVENUE -->
          <div style="padding: 15px; background: #f8fff8; border-radius: 6px; border: 1px solid #27ae60;">
            <div style="font-size: 20px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">
              $${totalRevenue.toLocaleString()}
            </div>
            <div style="font-size: 13px; color: #666;">Total Revenue</div>
            <div style="font-size: 11px; color: #27ae60; margin-top: 3px;">
              ${revenueAccounts.length} revenue stream${
          revenueAccounts.length !== 1 ? "s" : ""
        }
            </div>
          </div>

          <!-- EXPENSES -->
          <div style="padding: 15px; background: #fff8f8; border-radius: 6px; border: 1px solid #e74c3c;">
            <div style="font-size: 20px; font-weight: bold; color: #e74c3c; margin-bottom: 5px;">
              $${totalExpenses.toLocaleString()}
            </div>
            <div style="font-size: 13px; color: #666;">Total Expenses</div>
            <div style="font-size: 11px; color: #e74c3c; margin-top: 3px;">
              ${expenseAccounts.length} expense categor${
          expenseAccounts.length !== 1 ? "ies" : "y"
        }
            </div>
          </div>

          <!-- NET PROFIT -->
          <div style="padding: 15px; background: ${
            netProfit >= 0 ? "#f8fff8" : "#fff8f8"
          }; border-radius: 6px; border: 1px solid ${
          netProfit >= 0 ? "#27ae60" : "#e74c3c"
        };">
            <div style="font-size: 20px; font-weight: bold; color: ${
              netProfit >= 0 ? "#27ae60" : "#e74c3c"
            }; margin-bottom: 5px;">
              $${netProfit.toLocaleString()}
            </div>
            <div style="font-size: 13px; color: #666;">Net Profit</div>
            <div style="font-size: 11px; color: ${
              netProfit >= 0 ? "#27ae60" : "#e74c3c"
            }; margin-top: 3px;">
              ${netProfit >= 0 ? "Profitable" : "Loss"}
            </div>
          </div>

          <!-- PROFIT MARGIN -->
          <div style="padding: 15px; background: #f8fffe; border-radius: 6px; border: 1px solid #3498db;">
            <div style="font-size: 20px; font-weight: bold; color: #3498db; margin-bottom: 5px;">
              ${profitMargin.toFixed(1)}%
            </div>
            <div style="font-size: 13px; color: #666;">Profit Margin</div>
            <div style="font-size: 11px; color: #3498db; margin-top: 3px;">
              ${
                profitMargin > 20
                  ? "Excellent"
                  : profitMargin > 10
                  ? "Good"
                  : profitMargin > 0
                  ? "Fair"
                  : "Poor"
              }
            </div>
          </div>
        </div>
      </div>

      <!-- DETAILED BREAKDOWN -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
        
        <!-- REVENUE BREAKDOWN -->
        <div>
          <h4 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 8px; margin-bottom: 15px;">
            Revenue Breakdown (${revenueAccounts.length} streams)
          </h4>
          
          ${
            revenueAccounts.length === 0
              ? `
            <div style="text-align: center; padding: 30px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
              <h5>No Revenue Data</h5>
              <p style="font-size: 13px; margin-top: 8px;">No revenue accounts found for this period.</p>
            </div>
          `
              : `
            <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
              ${revenueAccounts
                .map((account) => {
                  const percentage =
                    totalRevenue > 0
                      ? (account.amount / totalRevenue) * 100
                      : 0;
                  return `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f0f0f0;">
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 13px; margin-bottom: 2px;">${
                        account.name
                      }</div>
                      <div style="font-size: 11px; color: #666;">${percentage.toFixed(
                        1
                      )}% of total revenue</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-weight: 600; color: #27ae60;">$${account.amount.toLocaleString()}</div>
                    </div>
                  </div>
                `;
                })
                .join("")}
            </div>
            
            <div style="border-top: 3px solid #27ae60; padding: 12px; font-weight: bold; color: #27ae60; background: #f8fff8; margin-top: 10px;">
              Total Revenue: $${totalRevenue.toLocaleString()}
            </div>
          `
          }
        </div>

        <!-- EXPENSE BREAKDOWN -->
        <div>
          <h4 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 8px; margin-bottom: 15px;">
            Expense Breakdown (${expenseAccounts.length} categories)
          </h4>
          
          ${
            expenseAccounts.length === 0
              ? `
            <div style="text-align: center; padding: 30px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
              <h5>No Expense Data</h5>
              <p style="font-size: 13px; margin-top: 8px;">No expense accounts found for this period.</p>
            </div>
          `
              : `
            <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
              ${expenseAccounts
                .map((account) => {
                  const percentage =
                    totalExpenses > 0
                      ? (account.amount / totalExpenses) * 100
                      : 0;
                  const isLarge = account.amount > totalExpenses * 0.1;
                  return `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f0f0f0; ${
                    isLarge ? "background: #fff8f8;" : ""
                  }">
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 13px; margin-bottom: 2px;">
                        ${account.name}
                        ${
                          isLarge
                            ? '<span style="color: #e74c3c; font-size: 10px; margin-left: 6px;">MAJOR</span>'
                            : ""
                        }
                      </div>
                      <div style="font-size: 11px; color: #666;">${percentage.toFixed(
                        1
                      )}% of total expenses</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-weight: 600; color: #e74c3c;">$${account.amount.toLocaleString()}</div>
                    </div>
                  </div>
                `;
                })
                .join("")}
            </div>
            
            <div style="border-top: 3px solid #e74c3c; padding: 12px; font-weight: bold; color: #e74c3c; background: #fff8f8; margin-top: 10px;">
              Total Expenses: $${totalExpenses.toLocaleString()}
            </div>
          `
          }
        </div>
      </div>

      <!-- P&L INSIGHTS -->
      <div style="margin-top: 25px; padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
        <h4 style="color: #0c5460; margin-bottom: 10px;">📊 Performance Insights</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 13px;">
          
          <div>
            <strong>Profitability Assessment:</strong>
            <div style="margin-top: 5px;">
              ${
                netProfit > 0
                  ? `Strong performance with $${netProfit.toLocaleString()} profit (${profitMargin.toFixed(
                      1
                    )}% margin)`
                  : netProfit === 0
                  ? "Break-even position - revenue equals expenses"
                  : `Loss of $${Math.abs(
                      netProfit
                    ).toLocaleString()} requires immediate attention`
              }
            </div>
          </div>

          <div>
            <strong>Revenue Concentration:</strong>
            <div style="margin-top: 5px;">
              ${
                revenueAccounts.length === 0
                  ? "No revenue streams identified"
                  : revenueAccounts.length === 1
                  ? "Single revenue stream - high concentration risk"
                  : revenueAccounts.length < 4
                  ? "Limited revenue diversification"
                  : "Well-diversified revenue streams"
              }
            </div>
          </div>

          <div>
            <strong>Expense Structure:</strong>
            <div style="margin-top: 5px;">
              ${
                largeExpenses.length === 0
                  ? "No major expense concentrations"
                  : largeExpenses.length === 1
                  ? `One major expense: ${largeExpenses[0].name}`
                  : `${largeExpenses.length} major expense categories require monitoring`
              }
            </div>
          </div>

          <div>
            <strong>Top Revenue Source:</strong>
            <div style="margin-top: 5px;">
              ${
                revenueAccounts.length > 0
                  ? `${
                      revenueAccounts[0].name
                    }: $${revenueAccounts[0].amount.toLocaleString()}`
                  : "No revenue data available"
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
      }

      // ====== CONSOLIDATED PROFIT & LOSS (MULTIPLE COMPANIES) ======
      async function loadConsolidatedProfitLoss() {
        const consolidatedData = {
          companies: [],
          totals: { totalRevenue: 0, totalExpenses: 0, netProfit: 0 },
          summary: {
            profitableCompanies: 0,
            lossCompanies: 0,
            breakEvenCompanies: 0,
          },
          accounts: { revenue: {}, expenses: {} },
        };

        // Load data from each selected company
        for (const tenantId of activeCompanyFilters) {
          const connectedCompany = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          if (!connectedCompany) continue;

          const orgName = getOrganizationName(connectedCompany.tenantName);
          const response = await fetchWithErrorHandling(
            "/api/profit-loss-summary",
            {
              organizationName: orgName,
            }
          );

          if (response && response.ok) {
            const data = await response.json();
            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );
            const summary = data.summary || {};

            const revenue = summary.totalRevenue || 0;
            const expenses = summary.totalExpenses || 0;
            const profit = summary.netProfit || 0;

            // Track company P&L status
            consolidatedData.companies.push({
              name: companyName,
              revenue: revenue,
              expenses: expenses,
              netProfit: profit,
              profitMargin: revenue > 0 ? (profit / revenue) * 100 : 0,
              status:
                profit > 0 ? "profitable" : profit === 0 ? "breakeven" : "loss",
              revenueStreams: (summary.revenueAccounts || []).length,
              expenseCategories: (summary.expenseAccounts || []).length,
            });

            // Aggregate totals
            consolidatedData.totals.totalRevenue += revenue;
            consolidatedData.totals.totalExpenses += expenses;
            consolidatedData.totals.netProfit += profit;

            // Update summary counts
            if (profit > 0) consolidatedData.summary.profitableCompanies++;
            else if (profit === 0)
              consolidatedData.summary.breakEvenCompanies++;
            else consolidatedData.summary.lossCompanies++;

            // Aggregate revenue accounts
            if (summary.revenueAccounts) {
              summary.revenueAccounts.forEach((account) => {
                if (!consolidatedData.accounts.revenue[account.name]) {
                  consolidatedData.accounts.revenue[account.name] = 0;
                }
                consolidatedData.accounts.revenue[account.name] +=
                  account.amount;
              });
            }

            // Aggregate expense accounts
            if (summary.expenseAccounts) {
              summary.expenseAccounts.forEach((account) => {
                if (!consolidatedData.accounts.expenses[account.name]) {
                  consolidatedData.accounts.expenses[account.name] = 0;
                }
                consolidatedData.accounts.expenses[account.name] +=
                  account.amount;
              });
            }
          }
        }

        renderConsolidatedProfitLoss(consolidatedData);
      }

      function renderConsolidatedProfitLoss(data) {
        const dashboardElement = document.getElementById("dashboardData");

        const consolidatedMargin =
          data.totals.totalRevenue > 0
            ? (data.totals.netProfit / data.totals.totalRevenue) * 100
            : 0;

        // Convert account objects to sorted arrays
        const consolidatedRevenue = Object.entries(data.accounts.revenue)
          .map(([name, amount]) => ({ name, amount }))
          .sort((a, b) => b.amount - a.amount);

        const consolidatedExpenses = Object.entries(data.accounts.expenses)
          .map(([name, amount]) => ({ name, amount }))
          .sort((a, b) => b.amount - a.amount);

        const healthyCompanies = data.summary.profitableCompanies;
        const problematicCompanies = data.summary.lossCompanies;

        dashboardElement.innerHTML = `
    <!-- CONSOLIDATED P&L HEADER -->
    <div class="dashboard-card">
      <h3>Consolidated Profit & Loss - ${data.companies.length} Companies</h3>
      
      <!-- CONSOLIDATED TOTALS -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
        
        <div style="text-align: center; padding: 20px; background: #f8fff8; border-radius: 6px; border: 1px solid #27ae60;">
          <div style="font-size: 24px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">
            $${data.totals.totalRevenue.toLocaleString()}
          </div>
          <div style="font-size: 14px; color: #666;">Total Revenue</div>
          <div style="font-size: 11px; color: #27ae60; margin-top: 5px;">
            ${consolidatedRevenue.length} revenue streams
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: #fff8f8; border-radius: 6px; border: 1px solid #e74c3c;">
          <div style="font-size: 24px; font-weight: bold; color: #e74c3c; margin-bottom: 5px;">
            $${data.totals.totalExpenses.toLocaleString()}
          </div>
          <div style="font-size: 14px; color: #666;">Total Expenses</div>
          <div style="font-size: 11px; color: #e74c3c; margin-top: 5px;">
            ${consolidatedExpenses.length} expense categories
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: ${
          data.totals.netProfit >= 0 ? "#f8fff8" : "#fff8f8"
        }; border-radius: 6px; border: 1px solid ${
          data.totals.netProfit >= 0 ? "#27ae60" : "#e74c3c"
        };">
          <div style="font-size: 24px; font-weight: bold; color: ${
            data.totals.netProfit >= 0 ? "#27ae60" : "#e74c3c"
          }; margin-bottom: 5px;">
            $${data.totals.netProfit.toLocaleString()}
          </div>
          <div style="font-size: 14px; color: #666;">Net Profit</div>
          <div style="font-size: 11px; color: ${
            data.totals.netProfit >= 0 ? "#27ae60" : "#e74c3c"
          }; margin-top: 5px;">
            ${data.totals.netProfit >= 0 ? "Profitable" : "Loss"}
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: #f8fffe; border-radius: 6px; border: 1px solid #3498db;">
          <div style="font-size: 24px; font-weight: bold; color: #3498db; margin-bottom: 5px;">
            ${consolidatedMargin.toFixed(1)}%
          </div>
          <div style="font-size: 14px; color: #666;">Profit Margin</div>
          <div style="font-size: 11px; color: #3498db; margin-top: 5px;">
            ${
              consolidatedMargin > 15
                ? "Excellent"
                : consolidatedMargin > 8
                ? "Good"
                : consolidatedMargin > 0
                ? "Fair"
                : "Poor"
            }
          </div>
        </div>
      </div>

      <!-- COMPANY PERFORMANCE SUMMARY -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
        <div style="text-align: center; padding: 15px; background: #f8fff8; border-radius: 6px; border: 1px solid #27ae60;">
          <div style="font-size: 20px; font-weight: bold; color: #27ae60;">${
            data.summary.profitableCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Profitable Companies</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fffdf5; border-radius: 6px; border: 1px solid #f39c12;">
          <div style="font-size: 20px; font-weight: bold; color: #f39c12;">${
            data.summary.breakEvenCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Break-Even</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fff8f8; border-radius: 6px; border: 1px solid #e74c3c;">
          <div style="font-size: 20px; font-weight: bold; color: #e74c3c;">${
            data.summary.lossCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Loss-Making</div>
        </div>
      </div>

      <!-- CONSOLIDATED ACCOUNTS SUMMARY -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
        
        <!-- TOP REVENUE SOURCES -->
        <div>
          <h4>Top Revenue Sources</h4>
          <div style="max-height: 40vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            ${consolidatedRevenue
              .slice(0, 10)
              .map((account) => {
                const percentage =
                  data.totals.totalRevenue > 0
                    ? (account.amount / data.totals.totalRevenue) * 100
                    : 0;
                return `
                <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 13px;">${
                      account.name
                    }</div>
                    <div style="font-size: 11px; color: #666;">${percentage.toFixed(
                      1
                    )}% of total</div>
                  </div>
                  <div style="font-weight: 600; color: #27ae60;">
                    $${account.amount.toLocaleString()}
                  </div>
                </div>
              `;
              })
              .join("")}
            ${
              consolidatedRevenue.length > 10
                ? `
              <div style="text-align: center; padding: 8px; color: #666; font-size: 12px;">
                ... and ${consolidatedRevenue.length - 10} more revenue streams
              </div>
            `
                : ""
            }
          </div>
        </div>

        <!-- TOP EXPENSE CATEGORIES -->
        <div>
          <h4>Top Expense Categories</h4>
          <div style="max-height: 40vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            ${consolidatedExpenses
              .slice(0, 10)
              .map((account) => {
                const percentage =
                  data.totals.totalExpenses > 0
                    ? (account.amount / data.totals.totalExpenses) * 100
                    : 0;
                return `
                <div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #f0f0f0;">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 13px;">${
                      account.name
                    }</div>
                    <div style="font-size: 11px; color: #666;">${percentage.toFixed(
                      1
                    )}% of total</div>
                  </div>
                  <div style="font-weight: 600; color: #e74c3c;">
                    $${account.amount.toLocaleString()}
                  </div>
                </div>
              `;
              })
              .join("")}
            ${
              consolidatedExpenses.length > 10
                ? `
              <div style="text-align: center; padding: 8px; color: #666; font-size: 12px;">
                ... and ${
                  consolidatedExpenses.length - 10
                } more expense categories
              </div>
            `
                : ""
            }
          </div>
        </div>
      </div>
    </div>

    <!-- INDIVIDUAL COMPANY PERFORMANCE -->
    <div class="dashboard-card">
      <h3>Individual Company Performance</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
        ${data.companies
          .map(
            (company) => `
          <div style="border: 1px solid ${
            company.status === "profitable"
              ? "#27ae60"
              : company.status === "breakeven"
              ? "#f39c12"
              : "#e74c3c"
          }; border-radius: 6px; padding: 15px; background: ${
              company.status === "profitable"
                ? "#f8fff8"
                : company.status === "breakeven"
                ? "#fffdf5"
                : "#fff8f8"
            };">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <strong style="font-size: 14px;">${company.name}</strong>
              <div style="font-size: 14px; font-weight: bold; color: ${
                company.status === "profitable"
                  ? "#27ae60"
                  : company.status === "breakeven"
                  ? "#f39c12"
                  : "#e74c3c"
              };">
                ${company.profitMargin.toFixed(1)}%
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px; margin-bottom: 8px;">
              <div>
                <div style="color: #666;">Revenue</div>
                <div style="font-weight: 600;">$${company.revenue.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666;">Expenses</div>
                <div style="font-weight: 600;">$${company.expenses.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666;">Net Profit</div>
                <div style="font-weight: 600; color: ${
                  company.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${company.netProfit.toLocaleString()}
                </div>
              </div>
            </div>
            
            <div style="font-size: 11px; color: #666;">
              ${company.revenueStreams} revenue stream${
              company.revenueStreams !== 1 ? "s" : ""
            } | 
              ${company.expenseCategories} expense categor${
              company.expenseCategories !== 1 ? "ies" : "y"
            } |
              Status: <span style="color: ${
                company.status === "profitable"
                  ? "#27ae60"
                  : company.status === "breakeven"
                  ? "#f39c12"
                  : "#e74c3c"
              }; font-weight: 500;">
                ${
                  company.status === "profitable"
                    ? "Profitable"
                    : company.status === "breakeven"
                    ? "Break-Even"
                    : "Loss"
                }
              </span>
            </div>
          </div>
        `
          )
          .join("")}
      </div>

      <!-- CONSOLIDATED P&L INSIGHTS -->
      <div style="margin-top: 25px; padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
        <h4 style="color: #0c5460; margin-bottom: 10px;">🏢 Consolidated Performance Insights</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 13px;">
          <div>
            <strong>Overall Health:</strong>
            <div style="margin-top: 5px;">
              ${
                healthyCompanies === data.companies.length
                  ? "Excellent - All companies profitable"
                  : healthyCompanies > problematicCompanies
                  ? "Good - Majority profitable"
                  : "Concerning - Multiple companies losing money"
              }
            </div>
          </div>
          <div>
            <strong>Revenue Diversity:</strong>
            <div style="margin-top: 5px;">
              ${
                consolidatedRevenue.length > 10
                  ? "Highly diversified revenue base"
                  : consolidatedRevenue.length > 5
                  ? "Moderately diversified"
                  : "Limited revenue diversification"
              }
            </div>
          </div>
          <div>
            <strong>Profit Distribution:</strong>
            <div style="margin-top: 5px;">
              ${
                data.companies.length > 0
                  ? `Average profit per company: $${Math.round(
                      data.totals.netProfit / data.companies.length
                    ).toLocaleString()}`
                  : "No data available"
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
      }

      // ====== YEAR-OVER-YEAR DATA LOADING - LOGICAL STRUCTURE ======

      // ====== FIXED YEAR-OVER-YEAR LOGIC WITH NULL SAFETY ======

      async function loadYearOverYearData() {
        if (activeCompanyFilters.length === 0) {
          showNoCompaniesSelected();
          return;
        }

        try {
          if (activeCompanyFilters.length === 1) {
            await loadSingleCompanyYoY();
          } else {
            await loadConsolidatedYoY();
          }
        } catch (error) {
          showErrorState(error);
        }
      }

      // ====== SINGLE COMPANY YEAR-OVER-YEAR (FIXED) ======
      async function loadSingleCompanyYoY() {
        const tenantId = activeCompanyFilters[0];
        const connectedCompany = connectedCompanies.find(
          (c) => c.tenantId === tenantId
        );

        if (!connectedCompany) return;

        const orgName = getOrganizationName(connectedCompany.tenantName);

        const [yoyResponse, monthlyResponse] = await Promise.all([
          fetchWithErrorHandling("/api/yoy-analysis", {
            organizationName: orgName,
          }),
          fetchWithErrorHandling("/api/monthly-breakdown", {
            organizationName: orgName,
          }),
        ]);

        let yoyData = null;
        let monthlyData = null;

        if (yoyResponse && yoyResponse.ok) {
          yoyData = await yoyResponse.json();
        }

        if (monthlyResponse && monthlyResponse.ok) {
          monthlyData = await monthlyResponse.json();
        }

        if (!yoyData && !monthlyData) {
          showErrorState(
            new Error(
              `Failed to load YoY analysis for ${connectedCompany.tenantName}`
            )
          );
          return;
        }

        renderSingleCompanyYoY(yoyData, monthlyData, connectedCompany);
      }

      function renderSingleCompanyYoY(yoyData, monthlyData, company) {
        const dashboardElement = document.getElementById("dashboardData");
        const companyName = company.tenantName.replace("Rirratjingu ", "");

        // Safe extraction of YoY data with defaults
        let yoyAnalysis = null;
        if (yoyData && yoyData.analysis) {
          yoyAnalysis = yoyData.analysis;
        }

        // Safe extraction of monthly data with defaults
        let monthlyBreakdown = [];
        let monthlyTotals = null;
        if (monthlyData && monthlyData.monthlyBreakdown) {
          monthlyBreakdown = monthlyData.monthlyBreakdown;
          monthlyTotals = monthlyData.totals;
        }

        // Helper function to safely format growth rates
        const safeGrowthFormat = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "N/A";
          return `${value >= 0 ? "+" : ""}${value.toFixed(1)}%`;
        };

        // Helper function to safely format currency
        const safeCurrencyFormat = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "$0";
          return `$${Math.abs(value).toLocaleString()}`;
        };

        // Helper function to get safe growth color
        const getGrowthColor = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "#666";
          return value >= 0 ? "#27ae60" : "#e74c3c";
        };

        dashboardElement.innerHTML = `
    <!-- SINGLE COMPANY YoY HEADER -->
    <div class="dashboard-card">
      <h3>Year-over-Year Analysis - ${companyName}</h3>
      
      ${
        yoyAnalysis
          ? `
        <!-- YoY PERFORMANCE COMPARISON -->
        <div style="margin-bottom: 25px;">
          <h4>Performance Comparison: ${
            yoyAnalysis.periods?.current?.label || "Current Year"
          } vs ${yoyAnalysis.periods?.previous?.label || "Previous Year"}</h4>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
            
            <!-- REVENUE YoY -->
            <div style="text-align: center; padding: 20px; background: ${
              (yoyAnalysis.growth?.revenue || 0) >= 0 ? "#f8fff8" : "#fff8f8"
            }; border-radius: 6px; border: 1px solid ${getGrowthColor(
              yoyAnalysis.growth?.revenue
            )};">
              <div style="font-size: 16px; font-weight: bold; color: ${getGrowthColor(
                yoyAnalysis.growth?.revenue
              )}; margin-bottom: 5px;">
                ${safeGrowthFormat(yoyAnalysis.growth?.revenue)}
              </div>
              <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Revenue Growth</div>
              <div style="font-size: 11px;">
                <div>Current: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.current?.revenue
                )}</div>
                <div>Previous: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.previous?.revenue
                )}</div>
              </div>
            </div>

            <!-- EXPENSES YoY -->
            <div style="text-align: center; padding: 20px; background: ${
              (yoyAnalysis.growth?.expenses || 0) <= 0 ? "#f8fff8" : "#fff8f8"
            }; border-radius: 6px; border: 1px solid ${
              (yoyAnalysis.growth?.expenses || 0) <= 0 ? "#27ae60" : "#e74c3c"
            };">
              <div style="font-size: 16px; font-weight: bold; color: ${
                (yoyAnalysis.growth?.expenses || 0) <= 0 ? "#27ae60" : "#e74c3c"
              }; margin-bottom: 5px;">
                ${safeGrowthFormat(yoyAnalysis.growth?.expenses)}
              </div>
              <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Expense Growth</div>
              <div style="font-size: 11px;">
                <div>Current: ${safeCurrencyFormat(
                  (yoyAnalysis.periods?.current?.revenue || 0) -
                    (yoyAnalysis.periods?.current?.profit || 0)
                )}</div>
                <div>Previous: ${safeCurrencyFormat(
                  (yoyAnalysis.periods?.previous?.revenue || 0) -
                    (yoyAnalysis.periods?.previous?.profit || 0)
                )}</div>
              </div>
            </div>

            <!-- PROFIT YoY -->
            <div style="text-align: center; padding: 20px; background: ${
              (yoyAnalysis.growth?.profit || 0) >= 0 ? "#f8fff8" : "#fff8f8"
            }; border-radius: 6px; border: 1px solid ${getGrowthColor(
              yoyAnalysis.growth?.profit
            )};">
              <div style="font-size: 16px; font-weight: bold; color: ${getGrowthColor(
                yoyAnalysis.growth?.profit
              )}; margin-bottom: 5px;">
                ${safeGrowthFormat(yoyAnalysis.growth?.profit)}
              </div>
              <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Profit Growth</div>
              <div style="font-size: 11px;">
                <div>Current: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.current?.profit
                )}</div>
                <div>Previous: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.previous?.profit
                )}</div>
              </div>
            </div>

            <!-- ASSETS YoY -->
            <div style="text-align: center; padding: 20px; background: ${
              (yoyAnalysis.growth?.assets || 0) >= 0 ? "#f8fff8" : "#fff8f8"
            }; border-radius: 6px; border: 1px solid ${getGrowthColor(
              yoyAnalysis.growth?.assets
            )};">
              <div style="font-size: 16px; font-weight: bold; color: ${getGrowthColor(
                yoyAnalysis.growth?.assets
              )}; margin-bottom: 5px;">
                ${safeGrowthFormat(yoyAnalysis.growth?.assets)}
              </div>
              <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Asset Growth</div>
              <div style="font-size: 11px;">
                <div>Current: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.current?.assets
                )}</div>
                <div>Previous: ${safeCurrencyFormat(
                  yoyAnalysis.periods?.previous?.assets
                )}</div>
              </div>
            </div>
          </div>

          <!-- GROWTH INSIGHTS -->
          <div style="padding: 15px; background: #f8fffe; border: 1px solid #bee5eb; border-radius: 6px;">
            <h5 style="color: #0c5460; margin-bottom: 10px;">Year-over-Year Performance Insights</h5>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 13px;">
              <div>
                <strong>Revenue Trend:</strong>
                <div style="margin-top: 5px;">
                  ${
                    (yoyAnalysis.growth?.revenue || 0) > 15
                      ? "Excellent growth - strong market performance"
                      : (yoyAnalysis.growth?.revenue || 0) > 5
                      ? "Good growth - steady expansion"
                      : (yoyAnalysis.growth?.revenue || 0) > 0
                      ? "Moderate growth - stable performance"
                      : (yoyAnalysis.growth?.revenue || 0) > -5
                      ? "Slight decline - monitor closely"
                      : "Significant decline - requires immediate attention"
                  }
                </div>
              </div>
              <div>
                <strong>Profitability Trend:</strong>
                <div style="margin-top: 5px;">
                  ${
                    (yoyAnalysis.growth?.profit || 0) >
                    (yoyAnalysis.growth?.revenue || 0)
                      ? "Improving efficiency - profit growing faster than revenue"
                      : (yoyAnalysis.growth?.profit || 0) > 0 &&
                        (yoyAnalysis.growth?.revenue || 0) > 0
                      ? "Healthy growth - both revenue and profit increasing"
                      : (yoyAnalysis.growth?.profit || 0) < 0 &&
                        (yoyAnalysis.growth?.revenue || 0) > 0
                      ? "Margin pressure - revenue up but profit declining"
                      : "Challenging period - both revenue and profit under pressure"
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      `
          : `
        <!-- NO YoY DATA AVAILABLE -->
        <div style="text-align: center; padding: 30px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; margin-bottom: 20px;">
          <h4>Year-over-Year Data Not Available</h4>
          <p>Unable to load YoY comparison data for ${companyName}.</p>
          <p style="font-size: 13px; margin-top: 8px;">This may indicate insufficient historical data or API connectivity issues.</p>
        </div>
      `
      }

      ${
        monthlyBreakdown.length > 0
          ? `
        <!-- MONTHLY PERFORMANCE TREND -->
        <div>
          <h4>Monthly Performance Breakdown (Last 12 Months)</h4>
          
          <!-- MONTHLY GRID -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
            ${monthlyBreakdown
              .map((month, index) => {
                const revenue = month.revenue || 0;
                const expenses = month.expenses || 0;
                const netProfit = month.netProfit || 0;
                const margin = revenue > 0 ? (netProfit / revenue) * 100 : 0;

                return `
                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; background: ${
                  netProfit >= 0 ? "#f8fff8" : "#fff8f8"
                }; font-size: 12px;">
                  <div style="font-weight: 600; margin-bottom: 8px; color: #2c3e50; text-align: center;">${
                    month.label || `Month ${index + 1}`
                  }</div>
                  
                  <div style="margin-bottom: 6px;">
                    <div style="color: #666;">Revenue</div>
                    <div style="font-weight: 600; color: #27ae60;">$${(
                      revenue / 1000
                    ).toFixed(0)}K</div>
                  </div>
                  
                  <div style="margin-bottom: 6px;">
                    <div style="color: #666;">Expenses</div>
                    <div style="font-weight: 600; color: #e74c3c;">$${(
                      expenses / 1000
                    ).toFixed(0)}K</div>
                  </div>
                  
                  <div style="margin-bottom: 6px;">
                    <div style="color: #666;">Profit</div>
                    <div style="font-weight: 600; color: ${
                      netProfit >= 0 ? "#27ae60" : "#e74c3c"
                    };">
                      $${(netProfit / 1000).toFixed(0)}K
                    </div>
                  </div>

                  <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid #f0f0f0;">
                    <div style="color: #666;">Margin</div>
                    <div style="font-weight: 600; color: #3498db;">
                      ${margin.toFixed(1)}%
                    </div>
                  </div>
                </div>
              `;
              })
              .join("")}
          </div>

          ${
            monthlyTotals
              ? `
            <!-- ANNUAL TOTALS SUMMARY -->
            <div style="border-top: 2px solid #2c3e50; padding: 20px; margin-top: 20px; background: #f8fffe;">
              <h5>12-Month Summary</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 15px;">
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: #27ae60;">
                    ${safeCurrencyFormat(monthlyTotals.revenue)}
                  </div>
                  <div style="font-size: 13px; color: #666;">Total Revenue</div>
                  <div style="font-size: 11px; color: #27ae60;">
                    Avg: ${safeCurrencyFormat(
                      (monthlyTotals.revenue || 0) / 12
                    )}/month
                  </div>
                </div>
                
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: #e74c3c;">
                    ${safeCurrencyFormat(monthlyTotals.expenses)}
                  </div>
                  <div style="font-size: 13px; color: #666;">Total Expenses</div>
                  <div style="font-size: 11px; color: #e74c3c;">
                    Avg: ${safeCurrencyFormat(
                      (monthlyTotals.expenses || 0) / 12
                    )}/month
                  </div>
                </div>
                
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: ${
                    (monthlyTotals.profit || 0) >= 0 ? "#27ae60" : "#e74c3c"
                  };">
                    ${safeCurrencyFormat(monthlyTotals.profit)}
                  </div>
                  <div style="font-size: 13px; color: #666;">Net Profit</div>
                  <div style="font-size: 11px; color: ${
                    (monthlyTotals.profit || 0) >= 0 ? "#27ae60" : "#e74c3c"
                  };">
                    Avg: ${safeCurrencyFormat(
                      (monthlyTotals.profit || 0) / 12
                    )}/month
                  </div>
                </div>
                
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: #3498db;">
                    ${
                      (monthlyTotals.revenue || 0) > 0
                        ? (
                            ((monthlyTotals.profit || 0) /
                              monthlyTotals.revenue) *
                            100
                          ).toFixed(1)
                        : 0
                    }%
                  </div>
                  <div style="font-size: 13px; color: #666;">Average Margin</div>
                  <div style="font-size: 11px; color: #3498db;">
                    ${
                      (monthlyTotals.profit || 0) > 0
                        ? "Profitable"
                        : "Unprofitable"
                    } year
                  </div>
                </div>
              </div>
            </div>
          `
              : ""
          }
        </div>
      `
          : ""
      }

      ${
        !yoyAnalysis && monthlyBreakdown.length === 0
          ? `
        <div style="text-align: center; padding: 40px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
          <h4>No YoY Data Available</h4>
          <p>Unable to load year-over-year analysis for ${companyName}.</p>
          <p style="font-size: 13px; margin-top: 10px;">This could indicate insufficient historical data or connectivity issues.</p>
        </div>
      `
          : ""
      }
    </div>
  `;
      }

      // ====== CONSOLIDATED YEAR-OVER-YEAR (FIXED) ======
      async function loadConsolidatedYoY() {
        const consolidatedData = {
          companies: [],
          consolidated: {
            current: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
            previous: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
            growth: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
          },
          summary: {
            growingCompanies: 0,
            decliningCompanies: 0,
            stableCompanies: 0,
          },
        };

        for (const tenantId of activeCompanyFilters) {
          const connectedCompany = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          if (!connectedCompany) continue;

          const orgName = getOrganizationName(connectedCompany.tenantName);
          const response = await fetchWithErrorHandling("/api/yoy-analysis", {
            organizationName: orgName,
          });

          if (response && response.ok) {
            const data = await response.json();
            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );

            if (data.analysis) {
              const analysis = data.analysis;

              // Safe extraction with defaults
              const currentRevenue = analysis.periods?.current?.revenue || 0;
              const currentProfit = analysis.periods?.current?.profit || 0;
              const currentAssets = analysis.periods?.current?.assets || 0;
              const currentEquity = analysis.periods?.current?.equity || 0;

              const previousRevenue = analysis.periods?.previous?.revenue || 0;
              const previousProfit = analysis.periods?.previous?.profit || 0;
              const previousAssets = analysis.periods?.previous?.assets || 0;
              const previousEquity = analysis.periods?.previous?.equity || 0;

              const revenueGrowth = analysis.growth?.revenue || 0;
              const profitGrowth = analysis.growth?.profit || 0;
              const assetsGrowth = analysis.growth?.assets || 0;

              consolidatedData.companies.push({
                name: companyName,
                current: {
                  revenue: currentRevenue,
                  profit: currentProfit,
                  assets: currentAssets,
                  equity: currentEquity,
                  label: analysis.periods?.current?.label || "Current Year",
                },
                previous: {
                  revenue: previousRevenue,
                  profit: previousProfit,
                  assets: previousAssets,
                  equity: previousEquity,
                  label: analysis.periods?.previous?.label || "Previous Year",
                },
                growth: {
                  revenue: revenueGrowth,
                  profit: profitGrowth,
                  assets: assetsGrowth,
                },
                status:
                  revenueGrowth > 5 && profitGrowth > 0
                    ? "growing"
                    : revenueGrowth < -5 || profitGrowth < -10
                    ? "declining"
                    : "stable",
              });

              // Aggregate consolidated totals
              consolidatedData.consolidated.current.revenue += currentRevenue;
              consolidatedData.consolidated.current.profit += currentProfit;
              consolidatedData.consolidated.current.assets += currentAssets;
              consolidatedData.consolidated.current.equity += currentEquity;
              consolidatedData.consolidated.current.expenses +=
                currentRevenue - currentProfit;

              consolidatedData.consolidated.previous.revenue += previousRevenue;
              consolidatedData.consolidated.previous.profit += previousProfit;
              consolidatedData.consolidated.previous.assets += previousAssets;
              consolidatedData.consolidated.previous.equity += previousEquity;
              consolidatedData.consolidated.previous.expenses +=
                previousRevenue - previousProfit;

              // Update status counts
              const status =
                consolidatedData.companies[
                  consolidatedData.companies.length - 1
                ].status;
              if (status === "growing")
                consolidatedData.summary.growingCompanies++;
              else if (status === "declining")
                consolidatedData.summary.decliningCompanies++;
              else consolidatedData.summary.stableCompanies++;
            }
          }
        }

        // Calculate consolidated growth rates with safety
        consolidatedData.consolidated.growth.revenue = calculateGrowthRate(
          consolidatedData.consolidated.previous.revenue,
          consolidatedData.consolidated.current.revenue
        );
        consolidatedData.consolidated.growth.expenses = calculateGrowthRate(
          consolidatedData.consolidated.previous.expenses,
          consolidatedData.consolidated.current.expenses
        );
        consolidatedData.consolidated.growth.profit = calculateGrowthRate(
          consolidatedData.consolidated.previous.profit,
          consolidatedData.consolidated.current.profit
        );
        consolidatedData.consolidated.growth.assets = calculateGrowthRate(
          consolidatedData.consolidated.previous.assets,
          consolidatedData.consolidated.current.assets
        );
        consolidatedData.consolidated.growth.equity = calculateGrowthRate(
          consolidatedData.consolidated.previous.equity,
          consolidatedData.consolidated.current.equity
        );

        renderConsolidatedYoY(consolidatedData);
      }

      function renderConsolidatedYoY(data) {
        const dashboardElement = document.getElementById("dashboardData");

        // Get period labels with safety
        const periodLabels =
          data.companies.length > 0
            ? {
                current: data.companies[0].current?.label || "Current Year",
                previous: data.companies[0].previous?.label || "Previous Year",
              }
            : {
                current: "Current Year",
                previous: "Previous Year",
              };

        const consolidated = data.consolidated;

        // Safe helper functions
        const safeGrowthFormat = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "N/A";
          return `${value >= 0 ? "+" : ""}${value.toFixed(1)}%`;
        };

        const safeCurrencyFormat = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "$0";
          return `$${Math.abs(value).toLocaleString()}`;
        };

        const getGrowthColor = (value) => {
          if (value === null || value === undefined || isNaN(value))
            return "#666";
          return value >= 0 ? "#27ae60" : "#e74c3c";
        };

        dashboardElement.innerHTML = `
    <!-- CONSOLIDATED YoY HEADER -->
    <div class="dashboard-card">
      <h3>Consolidated Year-over-Year Analysis - ${
        data.companies.length
      } Companies</h3>
      <div style="margin-bottom: 20px; text-align: center;">
        <div style="font-size: 14px; color: #666;">
          Comparing ${periodLabels.current} vs ${periodLabels.previous}
        </div>
      </div>

      <!-- CONSOLIDATED GROWTH METRICS -->
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px;">
        
        <div style="text-align: center; padding: 20px; background: ${
          consolidated.growth.revenue >= 0 ? "#f8fff8" : "#fff8f8"
        }; border-radius: 6px; border: 1px solid ${getGrowthColor(
          consolidated.growth.revenue
        )};">
          <div style="font-size: 20px; font-weight: bold; color: ${getGrowthColor(
            consolidated.growth.revenue
          )}; margin-bottom: 8px;">
            ${safeGrowthFormat(consolidated.growth.revenue)}
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Revenue Growth</div>
          <div style="font-size: 11px;">
            <div>Current: ${safeCurrencyFormat(
              consolidated.current.revenue
            )}</div>
            <div>Previous: ${safeCurrencyFormat(
              consolidated.previous.revenue
            )}</div>
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: ${
          consolidated.growth.expenses <= 0 ? "#f8fff8" : "#fff8f8"
        }; border-radius: 6px; border: 1px solid ${
          consolidated.growth.expenses <= 0 ? "#27ae60" : "#e74c3c"
        };">
          <div style="font-size: 20px; font-weight: bold; color: ${
            consolidated.growth.expenses <= 0 ? "#27ae60" : "#e74c3c"
          }; margin-bottom: 8px;">
            ${safeGrowthFormat(consolidated.growth.expenses)}
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Expense Growth</div>
          <div style="font-size: 11px;">
            <div>Current: ${safeCurrencyFormat(
              consolidated.current.expenses
            )}</div>
            <div>Previous: ${safeCurrencyFormat(
              consolidated.previous.expenses
            )}</div>
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: ${
          consolidated.growth.profit >= 0 ? "#f8fff8" : "#fff8f8"
        }; border-radius: 6px; border: 1px solid ${getGrowthColor(
          consolidated.growth.profit
        )};">
          <div style="font-size: 20px; font-weight: bold; color: ${getGrowthColor(
            consolidated.growth.profit
          )}; margin-bottom: 8px;">
            ${safeGrowthFormat(consolidated.growth.profit)}
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Profit Growth</div>
          <div style="font-size: 11px;">
            <div>Current: ${safeCurrencyFormat(
              consolidated.current.profit
            )}</div>
            <div>Previous: ${safeCurrencyFormat(
              consolidated.previous.profit
            )}</div>
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: ${
          consolidated.growth.assets >= 0 ? "#f8fff8" : "#fff8f8"
        }; border-radius: 6px; border: 1px solid ${getGrowthColor(
          consolidated.growth.assets
        )};">
          <div style="font-size: 20px; font-weight: bold; color: ${getGrowthColor(
            consolidated.growth.assets
          )}; margin-bottom: 8px;">
            ${safeGrowthFormat(consolidated.growth.assets)}
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Asset Growth</div>
          <div style="font-size: 11px;">
            <div>Current: ${safeCurrencyFormat(
              consolidated.current.assets
            )}</div>
            <div>Previous: ${safeCurrencyFormat(
              consolidated.previous.assets
            )}</div>
          </div>
        </div>

        <div style="text-align: center; padding: 20px; background: #f8fffe; border-radius: 6px; border: 1px solid #3498db;">
          <div style="font-size: 16px; font-weight: bold; color: #3498db; margin-bottom: 8px;">
            ${
              consolidated.current.revenue > 0
                ? (
                    (consolidated.current.profit /
                      consolidated.current.revenue) *
                    100
                  ).toFixed(1)
                : 0
            }%
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Current Margin</div>
          <div style="font-size: 11px;">
            <div>Previous: ${
              consolidated.previous.revenue > 0
                ? (
                    (consolidated.previous.profit /
                      consolidated.previous.revenue) *
                    100
                  ).toFixed(1)
                : 0
            }%</div>
          </div>
        </div>
      </div>

      <!-- COMPANY STATUS SUMMARY -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
        <div style="text-align: center; padding: 15px; background: #f8fff8; border-radius: 6px; border: 1px solid #27ae60;">
          <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${
            data.summary.growingCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Growing Companies</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fffdf5; border-radius: 6px; border: 1px solid #f39c12;">
          <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${
            data.summary.stableCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Stable Companies</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #fff8f8; border-radius: 6px; border: 1px solid #e74c3c;">
          <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${
            data.summary.decliningCompanies
          }</div>
          <div style="font-size: 13px; color: #666;">Declining Companies</div>
        </div>
      </div>
    </div>

    <!-- INDIVIDUAL COMPANY YoY PERFORMANCE -->
    <div class="dashboard-card">
      <h3>Individual Company Year-over-Year Performance</h3>
      ${
        data.companies.length === 0
          ? `
        <div style="text-align: center; padding: 40px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
          <h4>No YoY Data Available</h4>
          <p>Unable to load year-over-year data for any of the selected companies.</p>
          <p style="font-size: 13px; margin-top: 10px;">This may indicate API connectivity issues or insufficient historical data.</p>
        </div>
      `
          : `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px;">
          ${data.companies
            .map(
              (company) => `
            <div style="border: 1px solid ${
              company.status === "growing"
                ? "#27ae60"
                : company.status === "stable"
                ? "#f39c12"
                : "#e74c3c"
            }; border-radius: 6px; padding: 15px; background: ${
                company.status === "growing"
                  ? "#f8fff8"
                  : company.status === "stable"
                  ? "#fffdf5"
                  : "#fff8f8"
              };">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <strong style="font-size: 15px;">${company.name}</strong>
                <div style="display: flex; gap: 10px; font-size: 12px; font-weight: 500;">
                  <span style="color: ${getGrowthColor(
                    company.growth.revenue
                  )};">
                    Rev: ${safeGrowthFormat(company.growth.revenue)}
                  </span>
                  <span style="color: ${getGrowthColor(
                    company.growth.profit
                  )};">
                    Profit: ${safeGrowthFormat(company.growth.profit)}
                  </span>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 12px; margin-bottom: 12px;">
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Current Revenue</div>
                  <div style="font-weight: 600;">${safeCurrencyFormat(
                    company.current.revenue
                  )}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Previous Revenue</div>
                  <div style="font-weight: 600;">${safeCurrencyFormat(
                    company.previous.revenue
                  )}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Current Profit</div>
                  <div style="font-weight: 600; color: ${
                    company.current.profit >= 0 ? "#27ae60" : "#e74c3c"
                  };">
                    ${safeCurrencyFormat(company.current.profit)}
                  </div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Previous Profit</div>
                  <div style="font-weight: 600; color: ${
                    company.previous.profit >= 0 ? "#27ae60" : "#e74c3c"
                  };">
                    ${safeCurrencyFormat(company.previous.profit)}
                  </div>
                </div>
              </div>

              <div style="font-size: 11px; text-align: center; padding: 6px; border-radius: 4px; background: ${
                company.status === "growing"
                  ? "#e8f5e8"
                  : company.status === "stable"
                  ? "#fef9e7"
                  : "#fce8e8"
              };">
                Status: <span style="color: ${
                  company.status === "growing"
                    ? "#27ae60"
                    : company.status === "stable"
                    ? "#f39c12"
                    : "#e74c3c"
                }; font-weight: 500;">
                  ${
                    company.status === "growing"
                      ? "Growing"
                      : company.status === "stable"
                      ? "Stable"
                      : "Declining"
                  }
                </span>
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      `
      }
    </div>
  `;
      }

      async function loadAlertsData() {
        // Simplified version - full implementation would follow same pattern as overview
        showComingSoon("Financial Alerts");
      }

      function showComingSoon(featureName) {
        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 60px; color: #666;">
        <h3>${featureName}</h3>
        <p>This feature is being optimized and will be available in the next update.</p>
        <p style="margin-top: 20px; font-size: 14px;">
          Currently available: <strong>Overview</strong> and <strong>Trial Balance</strong>
        </p>
      </div>
    `;
      }
    </script>
  </body>
</html>
